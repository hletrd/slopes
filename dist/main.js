"serviceWorker"in navigator&&window.addEventListener("load",(function(){"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?navigator.serviceWorker.getRegistrations().then((function(registrations){for(let registration of registrations)registration.unregister()})):navigator.serviceWorker.register("./service-worker.js").then((function(registration){console.log("ServiceWorker registration successful with scope: ",registration.scope)})).catch((function(error){console.log("ServiceWorker registration failed: ",error)}))})),document.addEventListener("DOMContentLoaded",(function(){const toggleMenu=document.querySelector(".toggle-menu"),sidebar=document.querySelector(".sidebar"),sidebarBackdrop=document.querySelector(".sidebar-backdrop"),mainContent=document.querySelector(".main-content");let activePlayers=[],activeResort=null,activeWebcam=null,data=[],weatherData=[],isMobile=window.innerWidth<=768,favorites=function(){try{const favoritesData=localStorage.getItem("webcamFavorites");return favoritesData?JSON.parse(favoritesData):[]}catch(e){return console.error("Error loading favorites:",e),[]}}(),settings=function(){try{const settingsData=localStorage.getItem("webcamSettings");if(settingsData)return JSON.parse(settingsData)}catch(e){console.error("Error loading settings:",e)}return{autoplay:!isMobile}}();const settingsButton=document.getElementById("settingsButton"),settingsModal=document.getElementById("settingsModal"),closeSettingsModal=document.getElementById("closeSettingsModal"),autoplayToggle=document.getElementById("autoplayToggle");autoplayToggle.checked=settings.autoplay,autoplayToggle.addEventListener("change",(function(){settings.autoplay=this.checked,function(){try{localStorage.setItem("webcamSettings",JSON.stringify(settings))}catch(e){console.error("Error saving settings:",e)}}()})),settingsButton.addEventListener("click",(function(){settingsModal.style.display="block"})),closeSettingsModal.addEventListener("click",(function(){settingsModal.style.display="none"})),window.addEventListener("click",(function(event){event.target===settingsModal&&(settingsModal.style.display="none")}));const infoButton=document.getElementById("infoButton"),infoModal=document.getElementById("infoModal"),closeInfoModal=document.getElementById("closeInfoModal");infoButton.addEventListener("click",(function(){infoModal.style.display="flex"})),closeInfoModal.addEventListener("click",(function(){infoModal.style.display="none"})),window.addEventListener("click",(function(event){event.target===infoModal&&(infoModal.style.display="none")}));const addToHomeButton=document.getElementById("addToHomeButton"),installationModal=document.getElementById("installationModal"),closeModal=document.getElementById("closeModal");function saveFavorites(){try{localStorage.setItem("webcamFavorites",JSON.stringify(favorites))}catch(e){console.error("Error saving favorites:",e)}}function toggleFavorite(resortId,webcamIndex,webcamName,videoUrl,videoType){const index=favorites.findIndex((f=>f.resortId===resortId&&f.webcamIndex===webcamIndex));-1===index?favorites.push({resortId:resortId,webcamIndex:webcamIndex,webcamName:webcamName,resortName:data.find((r=>r.id===resortId))?.name||"",videoUrl:videoUrl,videoType:videoType}):favorites.splice(index,1),saveFavorites(),updateFavoriteButtons(),updateFavoritesDisplay()}function updateFavoriteButtons(){document.querySelectorAll(".bookmark-button").forEach((btn=>{!function(resortId,webcamIndex){return favorites.some((f=>f.resortId===resortId&&f.webcamIndex===webcamIndex))}(btn.getAttribute("data-resort-id"),parseInt(btn.getAttribute("data-webcam-index")))?(btn.classList.remove("active"),btn.querySelector(".bookmark-icon").innerHTML='<i class="bi bi-bookmark"></i>'):(btn.classList.add("active"),btn.querySelector(".bookmark-icon").innerHTML='<i class="bi bi-bookmark-fill"></i>')}))}function updateFavoritesDisplay(){const favoritesContainer=document.getElementById("favorites-container"),favoritesGrid=document.getElementById("favorites-grid");if(favoritesContainer&&favoritesGrid){if(0===favorites.length){const instruction=document.createElement("div");instruction.className="instruction",instruction.innerHTML="<p>북마크한 영상이 없습니다. 영상 오른쪽 위의 북마크 버튼을 눌러 영상을 추가해 보세요.<br>북마크는 같은 브라우저에서만 저장됩니다.</p>",favoritesContainer.appendChild(instruction)}if(favoritesContainer.style.display="block",favoritesGrid.innerHTML="",""===window.location.hash){const favoritesSection=favoritesContainer.closest(".content-section");favoritesSection&&(favoritesSection.style.display="block")}else{const favoritesSection=favoritesContainer.closest(".content-section");favoritesSection&&(favoritesSection.style.display="none")}activePlayers&&activePlayers.length>0&&(activePlayers=activePlayers.filter((player=>{const id=player.el_?.id;return!id||!id.includes("favorite-player")||(player.dispose(),!1)}))),favorites.forEach(((favorite,idx)=>{const videoCard=document.createElement("div");videoCard.className="video-card favorite-card",videoCard.draggable=!0,videoCard.setAttribute("data-index",idx);const dragHandle=document.createElement("div");dragHandle.className="drag-handle",dragHandle.innerHTML='<i class="bi bi-grip-vertical"></i>',videoCard.appendChild(dragHandle);const headerContainer=document.createElement("div");headerContainer.className="favorites-header-container";const header=document.createElement("div");header.className="favorite-header";const locationName=document.createElement("span");locationName.className="favorite-location cursor-pointer",locationName.textContent=favorite.webcamName,locationName.addEventListener("click",(function(){const hash=`${favorite.resortId}/${favorite.webcamIndex}`;window.location.hash=hash}));const resortName=document.createElement("span");resortName.className="favorite-resort",resortName.textContent=favorite.resortName,header.appendChild(locationName),header.appendChild(resortName),headerContainer.appendChild(header);const removeButton=document.createElement("button");removeButton.className="favorites-remove-button",removeButton.innerHTML='<i class="bi bi-trash"></i>',removeButton.setAttribute("title","북마크 제거"),removeButton.addEventListener("click",(function(e){e.preventDefault(),e.stopPropagation(),toggleFavorite(favorite.resortId,favorite.webcamIndex)})),headerContainer.appendChild(removeButton),videoCard.appendChild(headerContainer);const videoContainer=document.createElement("div");if(videoContainer.className="video-container",videoCard.appendChild(videoContainer),favoritesGrid.appendChild(videoCard),favorite.videoUrl){const playerId=`favorite-player-${idx}`,player=createVideoPlayer(favorite.videoUrl,videoContainer,playerId,favorite.videoType);player&&activePlayers.push(player)}videoCard.addEventListener("dragstart",handleDragStart),videoCard.addEventListener("dragover",handleDragOver),videoCard.addEventListener("dragenter",handleDragEnter),videoCard.addEventListener("dragleave",handleDragLeave),videoCard.addEventListener("drop",handleDrop),videoCard.addEventListener("dragend",handleDragEnd)})),updateAllResortsWeather()}else console.error("Favorites container or grid not found")}addToHomeButton.addEventListener("click",(function(){installationModal.style.display="block",setTimeout((function(){installationModal.classList.add("active")}),10)})),closeModal.addEventListener("click",(function(){installationModal.classList.remove("active"),setTimeout((function(){installationModal.style.display="none"}),400)})),installationModal.addEventListener("click",(function(event){event.target===installationModal&&closeModal.click()}));let draggedItem=null,dragSourceIndex=-1;function handleDragStart(e){draggedItem=this,dragSourceIndex=parseInt(this.getAttribute("data-index")),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",this.innerHTML),this.classList.add("dragging"),document.querySelectorAll(".favorite-card").forEach((card=>{card!==this&&card.classList.add("drop-target")}))}function handleDragOver(e){return e.preventDefault&&e.preventDefault(),e.dataTransfer.dropEffect="move",!1}function handleDragEnter(e){this.classList.add("drag-over")}function handleDragLeave(e){this.classList.remove("drag-over")}function handleDrop(e){if(e.stopPropagation(),e.preventDefault(),this.classList.remove("drag-over"),draggedItem===this)return!1;const dropTargetIndex=parseInt(this.getAttribute("data-index"));if(-1!==dragSourceIndex&&-1!==dropTargetIndex){const itemToMove=favorites[dragSourceIndex];favorites.splice(dragSourceIndex,1),favorites.splice(dropTargetIndex,0,itemToMove),saveFavorites(),updateFavoritesDisplay()}return!1}function handleDragEnd(e){document.querySelectorAll(".favorite-card").forEach((card=>{card.classList.remove("dragging","drag-over","drop-target")}))}function createLocationNameDiv(data,timestamp,displaySource=!1){const locationNameDiv=document.createElement("div");if(locationNameDiv.className="location-name",data.name.startsWith("리조트_")?locationNameDiv.textContent=data.name.replace("리조트_",""):locationNameDiv.textContent=data.name,timestamp){const date=new Date(timestamp);month=date.getMonth()+1,day=date.getDate(),hours=date.getHours().toString().padStart(2,"0"),minutes=date.getMinutes().toString().padStart(2,"0");const timeSpan=document.createElement("span");timeSpan.className="weather-update-time",timeSpan.textContent=`${month}월 ${day}일 ${hours}:${minutes} 기준`,displaySource&&(data.name.startsWith("리조트_")?timeSpan.textContent+=" (리조트 제공)":timeSpan.textContent+=" (기상청 제공)"),locationNameDiv.appendChild(timeSpan)}return locationNameDiv}function createWeatherDataDiv(data){const weatherDataDiv=document.createElement("div");weatherDataDiv.className="weather-data";class WeatherMetric{constructor(className,iconClass,value,unit,decimals=1){this.span=document.createElement("span"),this.span.className=className;const icon=document.createElement("i");icon.className=iconClass,this.span.appendChild(icon);const formattedValue=Number(value).toFixed(decimals);return this.span.appendChild(document.createTextNode(`${formattedValue}${unit}`)),this.span}}if(null!==data.temperature){const tempMetric=new WeatherMetric("temperature","bi bi-thermometer-half",data.temperature,"°C");weatherDataDiv.appendChild(tempMetric)}if(null!==data.humidity){weatherDataDiv.appendChild(document.createTextNode(" • "));const humidityMetric=new WeatherMetric("humidity","bi bi-moisture",data.humidity,"%",0);weatherDataDiv.appendChild(humidityMetric)}if(null!==data.wind_speed){weatherDataDiv.appendChild(document.createTextNode(" • "));const windMetric=new WeatherMetric("wind-speed","bi bi-wind",data.wind_speed,"m/s");weatherDataDiv.appendChild(windMetric)}if(null!==data.rainfall){weatherDataDiv.appendChild(document.createTextNode(" • "));const rainfallMetric=new WeatherMetric("rainfall","bi bi-droplet-fill",data.rainfall,"mm");weatherDataDiv.appendChild(rainfallMetric)}if(null!==data.snowfall_3hr){weatherDataDiv.appendChild(document.createTextNode(" • "));const snowfallMetric=new WeatherMetric("snowfall","bi bi-snow",data.snowfall_3hr,"cm");weatherDataDiv.appendChild(snowfallMetric)}return weatherDataDiv}function updateAllResortsWeather(){if(!weatherData||0===weatherData.length)return;if(!data||0===data.length)return;const defaultMessage=document.getElementById("default-message");if(!defaultMessage)return;const existingWeatherOverview=defaultMessage.querySelector(".all-resorts-weather");existingWeatherOverview&&existingWeatherOverview.remove();const allResortsWeatherContainer=document.createElement("div");allResortsWeatherContainer.className="all-resorts-weather",allResortsWeatherContainer.innerHTML='<h3>전국 스키장 날씨 <span style="font-size: 0.6em; font-weight: normal; color: #999; margin-left: 6px;">기상청 데이터 기준</span></h3>';const weatherGrid=document.createElement("div");if(weatherGrid.className="weather-container",allResortsWeatherContainer.appendChild(weatherGrid),data.forEach((resort=>{const resortName=resort.name,baseAreaWeather=weatherData.find((w=>w.resort===resortName&&"스키하우스"===w.name));if(baseAreaWeather&&baseAreaWeather.data&&baseAreaWeather.data.length>0){const wrapper=document.createElement("div");wrapper.className="weather-info-wrapper";const weatherInfo=document.createElement("div");weatherInfo.className="weather-info";const mostRecent=baseAreaWeather.data[baseAreaWeather.data.length-1],locationNameDiv=createLocationNameDiv(resort,baseAreaWeather.timestamp,!1),weatherDataDiv=createWeatherDataDiv(mostRecent);weatherInfo.appendChild(locationNameDiv),weatherInfo.appendChild(weatherDataDiv),wrapper.appendChild(weatherInfo),weatherGrid.appendChild(wrapper)}})),weatherGrid.children.length>0){const favoritesContainer=defaultMessage.querySelector("#favorites-container");favoritesContainer?favoritesContainer.after(allResortsWeatherContainer):defaultMessage.appendChild(allResortsWeatherContainer)}const resortProvidedWeatherTitle=document.createElement("h3");resortProvidedWeatherTitle.style.marginTop="16px",resortProvidedWeatherTitle.textContent="전국 스키장 날씨";const resortProvidedWeatherSpan=document.createElement("span");resortProvidedWeatherSpan.textContent="리조트 데이터 기준",resortProvidedWeatherSpan.style.fontSize="0.6em",resortProvidedWeatherSpan.style.fontWeight="normal",resortProvidedWeatherSpan.style.color="#999",resortProvidedWeatherSpan.style.marginLeft="6px",resortProvidedWeatherTitle.appendChild(resortProvidedWeatherSpan),allResortsWeatherContainer.appendChild(resortProvidedWeatherTitle);const resortProvidedWeatherGrid=document.createElement("div");if(resortProvidedWeatherGrid.className="weather-container",allResortsWeatherContainer.appendChild(resortProvidedWeatherGrid),data.forEach((resort=>{const resortName=resort.name;weatherData.filter((w=>w.resort===resortName&&w.name.startsWith("리조트_"))).forEach((baseAreaWeather=>{if(baseAreaWeather&&baseAreaWeather.data&&baseAreaWeather.data.length>0){const wrapper=document.createElement("div");wrapper.className="weather-info-wrapper";const weatherInfo=document.createElement("div");weatherInfo.className="weather-info";const mostRecent=baseAreaWeather.data[baseAreaWeather.data.length-1],locationNameDiv=createLocationNameDiv(resort,baseAreaWeather.timestamp,!1),weatherDataDiv=createWeatherDataDiv(mostRecent);weatherInfo.appendChild(locationNameDiv),weatherInfo.appendChild(weatherDataDiv),wrapper.appendChild(weatherInfo),resortProvidedWeatherGrid.appendChild(wrapper)}}))})),resortProvidedWeatherGrid.children.length>0){const favoritesContainer=defaultMessage.querySelector("#favorites-container");favoritesContainer?favoritesContainer.after(allResortsWeatherContainer):defaultMessage.appendChild(allResortsWeatherContainer)}}function hideAllSubmenus(){document.querySelectorAll(".submenu").forEach((submenu=>{submenu.classList.remove("active")})),document.querySelectorAll('.menu-item[data-has-submenu="true"]').forEach((item=>{item.classList.remove("active")})),document.querySelectorAll(".dropdown-toggle").forEach((toggle=>{toggle.innerHTML='<i class="bi bi-chevron-down"></i>'}))}function updateUrlHash(resort,webcam){const newHash=webcam?`${resort}/${webcam}`:resort;if(window.location.hash.substring(1)===newHash)return;const url=new URL(window.location);url.hash=newHash,history.pushState(null,"",url),updatePageTitle(resort,webcam)}function updatePageTitle(resortId,webcamId){if(!resortId)return void(document.title="Slopes cam");const resort=data.find((r=>r.id===resortId));if(resort)if(null!=webcamId){const webcamIndex=parseInt(webcamId),webcams=resort.links||resort.webcams||[];if(!isNaN(webcamIndex)&&webcams[webcamIndex]){const webcamName=webcams[webcamIndex].name;document.title=`Slopes cam - ${webcamName} - ${resort.name}`}else document.title=`Slopes cam - ${resort.name}`}else document.title=`Slopes cam - ${resort.name}`;else document.title="Slopes cam"}function disposeAllPlayers(){activePlayers&&activePlayers.length>0&&(activePlayers.forEach((player=>{player&&"function"==typeof player.dispose&&player.dispose()})),activePlayers=[])}function updateWeatherDisplay(resortId){if(!weatherData||0===weatherData.length)return;const resort=data.find((r=>r.id===resortId));if(!resort)return;const resortName=resort.name,resortWeather=weatherData.filter((w=>w.resort===resortName));if(0===resortWeather.length)return;document.querySelectorAll(`.content-section[id^="${resortId}"]`).forEach((section=>{const existingWeather=section.querySelector(".weather-container");existingWeather&&existingWeather.remove();const weatherContainer=document.createElement("div");weatherContainer.className="weather-container",resortWeather.forEach((locationData=>{if(!locationData||!locationData.data||0===locationData.data.length)return;const mostRecent=locationData.data[locationData.data.length-1],weatherInfoWrapper=document.createElement("div");weatherInfoWrapper.className="weather-info-wrapper";const weatherInfo=document.createElement("div");weatherInfo.className="weather-info";const locationNameDiv=createLocationNameDiv(locationData,locationData.timestamp,!0),weatherDataDiv=createWeatherDataDiv(mostRecent);weatherInfo.appendChild(locationNameDiv),weatherInfo.appendChild(weatherDataDiv),weatherInfoWrapper.appendChild(weatherInfo),weatherContainer.appendChild(weatherInfoWrapper)}));const videosGrid=section.querySelector(".videos-grid"),videoContainer=section.querySelector(".video-container");if(videosGrid)videosGrid.after(weatherContainer);else if(videoContainer)videoContainer.after(weatherContainer);else{const title=section.querySelector("h2");title?title.after(weatherContainer):section.appendChild(weatherContainer)}}))}function handleHashChange(){const hash=window.location.hash.substring(1);if(!hash){document.querySelectorAll(".content-section").forEach((section=>{section.classList.remove("active")}));const defaultMessage=document.getElementById("default-message");return defaultMessage.classList.add("active"),defaultMessage.style.display="block",updateFavoritesDisplay(),void(document.title="Slopes cam")}if(!window.processingHashChange){window.processingHashChange=!0;try{const parts=hash.split("/"),resortId=parts[0],webcamId=parts[1];updatePageTitle(resortId,webcamId);const defaultMessage=document.getElementById("default-message");defaultMessage.classList.remove("active"),defaultMessage.style.display="none";const resortMenuItem=document.querySelector(`.menu-item[data-target="${resortId}"]`);if(resortMenuItem){document.querySelectorAll(".menu-item").forEach((mi=>mi.classList.remove("active"))),resortMenuItem.classList.add("active"),hideAllSubmenus(),resortMenuItem.classList.add("active"),disposeAllPlayers(),document.querySelectorAll(".content-section").forEach((section=>{section.classList.remove("active")}));if("true"===resortMenuItem.getAttribute("data-has-submenu")){const submenu=document.getElementById(`${resortId}-submenu`);if(submenu&&submenu.classList.add("active"),webcamId){const webcamIndex=parseInt(webcamId);if(!isNaN(webcamIndex)){const webcamItem=document.querySelector(`#${resortId}-submenu .submenu-item[data-webcam-index="${webcamIndex}"]`);if(webcamItem){document.querySelectorAll(".submenu-item").forEach((item=>{item.classList.remove("active")})),webcamItem.classList.add("active");const targetSection=document.getElementById(webcamItem.getAttribute("data-target"));if(targetSection){targetSection.classList.add("active");const videoContainer=targetSection.querySelector(".video-container");if(videoContainer){const resort=data.find((r=>r.id===resortId));if(resort){const webcams=resort.links||resort.webcams||[];if(webcams[webcamIndex]){const videoUrl=webcams[webcamIndex].video||webcams[webcamIndex].link;if(videoUrl){const player=createVideoPlayer(videoUrl,videoContainer,`${resortId}-${webcamIndex}`,webcams[webcamIndex].video_type);player&&activePlayers.push(player),addBookmarkButton(videoContainer,resortId,webcamIndex,webcams[webcamIndex].name,videoUrl,webcams[webcamIndex].video_type),updateWeatherDisplay(resortId)}else videoContainer.innerHTML='<div class="error-message">No video stream available</div>'}else videoContainer.innerHTML='<div class="error-message">No video stream available</div>'}}}}}}else{document.querySelectorAll(".submenu-item").forEach((smi=>smi.classList.remove("active")));const mainSection=document.getElementById(`${resortId}-main`);mainSection&&(mainSection.classList.add("active"),loadAllWebcams(resortId))}const dropdownToggle=resortMenuItem.querySelector(".dropdown-toggle");dropdownToggle&&(dropdownToggle.innerHTML='<i class="bi bi-chevron-up"></i>')}else{const targetSection=document.getElementById(resortId);targetSection&&targetSection.classList.add("active")}weatherData&&weatherData.length>0?updateWeatherDisplay(resortId):fetch("weather.json?v="+(new Date).getTime()).then((response=>response.ok?response.json():(console.warn("Weather data not available"),null))).then((data=>{data&&(weatherData=data,console.log("Weather data loaded:",weatherData.length,"locations"),updateWeatherDisplay(resortId))})).catch((error=>{console.error("Error loading weather data:",error)}))}}finally{setTimeout((()=>{window.processingHashChange=!1,updateFavoriteButtons()}),100)}}}function loadAllWebcams(resortId){const resort=data.find((r=>r.id===resortId));if(!resort)return;const webcams=resort.links||resort.webcams||[];if(0===webcams.length)return;const mainSection=document.getElementById(`${resortId}-main`);if(!mainSection)return;let videosGrid=mainSection.querySelector(".videos-grid");if(!videosGrid){videosGrid=document.createElement("div"),videosGrid.className="videos-grid";const title=mainSection.querySelector("h2");title?title.after(videosGrid):mainSection.appendChild(videosGrid)}videosGrid.innerHTML="",webcams.forEach(((webcam,index)=>{const videoUrl=webcam.video||webcam.link;if(!videoUrl)return;const videoCard=document.createElement("div");videoCard.className="video-card";const cardTitle=document.createElement("h3");cardTitle.textContent=webcam.name,cardTitle.className="cursor-pointer",cardTitle.addEventListener("click",(function(){const submenuItem=document.querySelector(`#${resortId}-submenu .submenu-item[data-webcam-index="${index}"]`);submenuItem&&submenuItem.click()})),videoCard.appendChild(cardTitle);const videoContainer=document.createElement("div");videoContainer.className="video-container",videoCard.appendChild(videoContainer),videosGrid.appendChild(videoCard);const player=createVideoPlayer(videoUrl,videoContainer,`${resortId}-grid-${index}`,webcam.video_type);player&&activePlayers.push(player),addBookmarkButton(videoContainer,resortId,index,webcam.name,videoUrl,webcam.video_type)})),updateFavoriteButtons(),updateWeatherDisplay(resortId)}function createVideoPlayer(videoUrl,container,id,videoType){container.innerHTML="";const idParts=id.split("-"),resortId=idParts[0];let webcamIndex=parseInt(idParts[1]);3===idParts.length&&"grid"===idParts[1]&&(webcamIndex=parseInt(idParts[2]));let webcamName="";if(resortId&&!isNaN(webcamIndex)){const resort=data.find((r=>r.id===resortId));if(resort){const webcams=resort.links||resort.webcams||[];webcams[webcamIndex]&&(webcamName=webcams[webcamIndex].name||"")}}if("vivaldi"===videoType){const vivaldiContainer=document.createElement("div");vivaldiContainer.className="iframe-container";const vivaldiParams=videoUrl.split(":");if(2===vivaldiParams.length){const channel=vivaldiParams[0],serial=vivaldiParams[1];vivaldiContainer.innerHTML=`<iframe src="vivaldi.html?channel=${channel}&serial=${serial}&autoplay=${settings.autoplay}" allowfullscreen></iframe>`,container.appendChild(vivaldiContainer),resortId&&!isNaN(webcamIndex)&&addBookmarkButton(container,resortId,webcamIndex,webcamName,videoUrl,videoType,BookmarkButtonType.VIVALDI);const captureBtn=document.createElement("button");return captureBtn.className="capture-button",captureBtn.innerHTML='\n          <i class="bi bi-camera"></i>\n          캡처\n          ',captureBtn.addEventListener("click",(()=>function(container){try{const iframe=container.querySelector("iframe");if(!iframe)return void alert("캡처할 영상을 찾을 수 없습니다.");const parentSection=container.closest(".content-section");let resortName,webcamName;if(parentSection){const idParts=parentSection.id.split("-");if(idParts.length>=3&&"webcam"===idParts[1]){const resortId=idParts[0],webcamIndex=parseInt(idParts[2]),resort=data.find((r=>r.id===resortId));if(resort&&!isNaN(webcamIndex)){(resort.links||resort.webcams||[])[webcamIndex]&&(resortName=getResortNameForCapture(container),webcamName=getWebcamNameForCapture(container))}}}if(!resortName||!webcamName){const parts=window.location.hash.substring(1).split("/");if(parts.length>1){const resortId=parts[0],webcamIdx=parseInt(parts[1]),resort=data.find((r=>r.id===resortId));if(resort&&!isNaN(webcamIdx)){(resort.links||resort.webcams||[])[webcamIdx]&&(resortName=getResortNameForCapture(container),webcamName=getWebcamNameForCapture(container))}}}resortName||(resortName=getResortNameForCapture(container)),webcamName||(webcamName=getWebcamNameForCapture(container));const filename=`capture_${resortName}_${webcamName}_${formatTimestamp()}.jpg`,iframeBody=iframe.contentDocument.body;html2canvas(iframeBody,{useCORS:!1}).then((canvas=>{downloadImage(canvas.toDataURL("image/jpeg"),filename),showSuccessMessage(container)}))}catch(e){console.error("Error capturing screenshot:",e),alert("캡처 중 오류가 발생했습니다.")}}(container))),container.appendChild(captureBtn),{dispose:function(){container.innerHTML=""}}}return container.innerHTML='<div class="error-message">Invalid vivaldi video URL format. Expected: "channel:serial"</div>',null}if("iframe"===videoType){const iframeContainer=document.createElement("div");return iframeContainer.className="iframe-container",iframeContainer.innerHTML=`<iframe src="${videoUrl}" allowfullscreen></iframe>`,container.appendChild(iframeContainer),resortId&&!isNaN(webcamIndex)&&addBookmarkButton(container,resortId,webcamIndex,webcamName,videoUrl,videoType,BookmarkButtonType.LINK),{dispose:function(){container.innerHTML=""}}}if("youtube"===videoType){const youtubeContainer=document.createElement("div");youtubeContainer.className="iframe-container";const youtubeId=function(url){const liveRegExp=/^(?:https?:\/\/)?(?:www\.)?youtube\.com\/live\/([^#&?]*).*/,liveMatch=url.match(liveRegExp);if(liveMatch&&liveMatch[1]&&11===liveMatch[1].length)return liveMatch[1];const regExp=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/,match=url.match(regExp);return match&&11===match[2].length?match[2]:null}(videoUrl);if(youtubeId){const autoplayParam=settings.autoplay?"1":"0";return youtubeContainer.innerHTML=`<iframe src="https://www.youtube.com/embed/${youtubeId}?autoplay=${autoplayParam}&mute=1" allowfullscreen></iframe>`,container.appendChild(youtubeContainer),resortId&&!isNaN(webcamIndex)&&addBookmarkButton(container,resortId,webcamIndex,webcamName,videoUrl,videoType,BookmarkButtonType.YOUTUBE),{dispose:function(){container.innerHTML=""}}}}if("link"===videoType){const linkContainer=document.createElement("div");linkContainer.className="d-flex justify-content-center align-items-center link-container";const linkButton=document.createElement("a");return linkButton.href=videoUrl,linkButton.target="_blank",linkButton.rel="noopener noreferrer",linkButton.className="btn btn-primary btn-lg",linkButton.innerHTML='\n        <i class="bi bi-box-arrow-up-right me-2"></i>\n        외부 링크\n      ',linkContainer.appendChild(linkButton),container.appendChild(linkContainer),resortId&&!isNaN(webcamIndex)&&addBookmarkButton(container,resortId,webcamIndex,webcamName,videoUrl,videoType,BookmarkButtonType.LINK),{dispose:function(){container.innerHTML=""}}}const resort=function(id){if(!id||!id.includes("-"))return null;const parts=id.split("-");if(parts.length<2)return null;const resortId=parts[0];let webcamIndex=parseInt(parts[1]);3===parts.length&&"grid"===parts[1]&&(webcamIndex=parseInt(parts[2]));if(isNaN(webcamIndex))return null;const resort=data.find((r=>r.id===resortId));if(!resort)return null;const webcams=resort.links||resort.webcams||[];return webcams[webcamIndex]?{resort:resort,webcam:webcams[webcamIndex]}:null}(id);let linkUrl=null;resort&&resort.webcam&&resort.webcam.link&&(linkUrl=resort.webcam.link),container.innerHTML=`\n      <video\n        id="webcam-player-${id}"\n        class="video-js vjs-theme-forest vjs-big-play-centered"\n        controls\n        ${settings.autoplay?"autoplay":""}\n        muted\n        playsinline\n      >\n        <source src="${videoUrl}" type="application/x-mpegURL">\n        <p class="vjs-no-js">\n          최신 브라우저를 사용하세요.\n        </p>\n      </video>\n    `;try{const player=videojs(`webcam-player-${id}`,{liveui:!0,responsive:!0,fluid:!1,crossorigin:"anonymous",liveTracker:{trackingThreshold:0,liveTolerance:15}}),captureBtn=document.createElement("button");if(captureBtn.className="capture-button",captureBtn.innerHTML='\n        <i class="bi bi-camera"></i>\n        캡처\n      ',captureBtn.addEventListener("click",(()=>function(player){try{const canvas=document.createElement("canvas"),video=player.el().querySelector("video");canvas.width=video.videoWidth,canvas.height=video.videoHeight;canvas.getContext("2d").drawImage(video,0,0,canvas.width,canvas.height);const playerId=player.el().id;let resortId,webcamIndex;if(playerId){const idParts=playerId.replace("webcam-player-","").split("-");if(idParts.length>=2){"grid"===idParts[1]?(resortId=idParts[0],webcamIndex=parseInt(idParts[2])):(resortId=idParts[0],webcamIndex=parseInt(idParts[1]));const resort=data.find((r=>r.id===resortId));if(resort&&!isNaN(webcamIndex)){if((resort.links||resort.webcams||[])[webcamIndex]){const resortName=getResortNameForCapture(player.el()),webcamName=getWebcamNameForCapture(player.el()),filename=`capture_${resortName}_${webcamName}_${formatTimestamp()}.jpg`;downloadImage(canvas.toDataURL("image/jpeg"),filename);return void showSuccessMessage(player.el().parentNode)}}}}const resortName=getResortNameForCapture(player.el()),webcamName=getWebcamNameForCapture(player.el()),filename=`capture_${resortName}_${webcamName}_${formatTimestamp()}.jpg`;downloadImage(canvas.toDataURL("image/jpeg"),filename);showSuccessMessage(player.el().parentNode)}catch(e){console.error("Error capturing frame:",e),alert("캡처 중 오류가 발생했습니다.")}}(player))),container.appendChild(captureBtn),document.pictureInPictureEnabled||document.exitPictureInPicture&&document.requestPictureInPicture){const pipBtn=document.createElement("button");pipBtn.className="pip-button",pipBtn.innerHTML='\n          <i class="bi bi-pip"></i>\n          PIP\n        ',pipBtn.addEventListener("click",(()=>function(player){const video=player.el().querySelector("video");if(!video)return;document.pictureInPictureElement?document.exitPictureInPicture().catch((error=>{console.error("Error exiting Picture-in-Picture mode:",error)})):(document.pictureInPictureEnabled||video.requestPictureInPicture)&&video.requestPictureInPicture().catch((error=>{console.error("Error entering Picture-in-Picture mode:",error)}))}(player))),container.appendChild(pipBtn)}return resortId&&!isNaN(webcamIndex)&&addBookmarkButton(container,resortId,webcamIndex,webcamName,videoUrl,videoType,BookmarkButtonType.DEFAULT),player.on("error",(function(){const error=player.error();console.error("Video player error:",error);let directLink=null;if(resort&&resort.webcam)directLink=resort.webcam.link||null;else{const resortData=data.find((r=>r.id===resortId));if(resortData){const webcams=resortData.links||resortData.webcams||[];webcams[webcamIndex]&&webcams[webcamIndex].link&&(directLink=webcams[webcamIndex].link)}}let errorHtml='<div class="error-message"><p>비디오 재생 중 오류가 발생했습니다.</p>';directLink&&(errorHtml+=`<div class="mt-3">\n            <a href="${directLink}" target="_blank" rel="noopener noreferrer" class="btn btn-primary">\n              <i class="bi bi-box-arrow-up-right me-2"></i>\n              원본 링크에서 보기\n            </a>\n          </div>`),errorHtml+="</div>",container.innerHTML=errorHtml,resortId&&!isNaN(webcamIndex)&&addBookmarkButton(container,resortId,webcamIndex,webcamName,videoUrl,videoType,BookmarkButtonType.ERROR)})),player}catch(e){return console.error("Error creating video player:",e),container.innerHTML='<div class="error-message">비디오 플레이어를 생성하는 중 오류가 발생했습니다.</div>',resortId&&!isNaN(webcamIndex)&&addBookmarkButton(container,resortId,webcamIndex,webcamName,videoUrl,videoType,BookmarkButtonType.ERROR),null}}const BookmarkButtonType={ERROR:1,LINK:2,YOUTUBE:3,VIVALDI:4,DEFAULT:0};function addBookmarkButton(container,resortId,webcamIndex,webcamName,videoUrl,videoType,type=BookmarkButtonType.DEFAULT){if("string"==typeof resortId&&resortId.includes("favorite-player"))return;if(container.querySelector(".bookmark-button"))return;const bookmarkBtn=document.createElement("button");bookmarkBtn.className="bookmark-button",bookmarkBtn.setAttribute("data-resort-id",resortId),bookmarkBtn.setAttribute("data-webcam-index",webcamIndex),bookmarkBtn.innerHTML='\n      <span class="bookmark-icon"><i class="bi bi-bookmark"></i></span>\n      북마크\n    ',bookmarkBtn.addEventListener("click",(function(){toggleFavorite(resortId,webcamIndex,webcamName,videoUrl,videoType)})),type===BookmarkButtonType.ERROR?bookmarkBtn.classList.add("bookmark-button-error"):type===BookmarkButtonType.LINK?bookmarkBtn.classList.add("bookmark-button-link"):type===BookmarkButtonType.YOUTUBE?bookmarkBtn.classList.add("bookmark-button-youtube"):type===BookmarkButtonType.VIVALDI&&bookmarkBtn.classList.add("bookmark-button-vivaldi"),container.appendChild(bookmarkBtn)}function showSuccessMessage(container){const successMsg=document.createElement("div");successMsg.className="alert alert-success position-absolute top-0 start-50 translate-middle-x mt-3 success-message",successMsg.textContent="캡처 완료!",container.appendChild(successMsg),setTimeout((()=>{successMsg.classList.add("fade-out"),setTimeout((()=>{successMsg.remove()}),500)}),2e3)}function getResortNameForCapture(element){if(element){const favoriteCard=element.closest(".favorite-card");if(favoriteCard){const favoriteResort=favoriteCard.querySelector(".favorite-resort");if(favoriteResort&&favoriteResort.textContent)return sanitizeForFilename(favoriteResort.textContent.trim())}}const resortLabel=document.querySelector(".content-section.active .resort-label");if(resortLabel&&resortLabel.textContent)return sanitizeForFilename(resortLabel.textContent.trim());const hash=window.location.hash.substring(1);if(hash){const resortId=hash.split("/")[0],resort=data.find((r=>r.id===resortId));if(resort)return sanitizeForFilename(resort.name)}const activeMenuItem=document.querySelector(".menu-item.active");if(activeMenuItem){return sanitizeForFilename(activeMenuItem.textContent.trim().split("\n")[0])}return"unknown"}function getWebcamNameForCapture(element){const videoContainer=element.closest(".video-container"),favoriteCard=videoContainer?.closest(".favorite-card");if(favoriteCard){const favoriteLocation=favoriteCard.querySelector(".favorite-location");if(favoriteLocation&&favoriteLocation.textContent)return sanitizeForFilename(favoriteLocation.textContent.trim())}const playerElement=videoContainer.querySelector(".vjs-tech")||videoContainer.querySelector("iframe")||videoContainer.querySelector(".vivaldi-container");if(playerElement&&playerElement.id){const idMatch=playerElement.id.match(/player-([^-]+)-(\d+)/)||playerElement.id.match(/player-([^-]+)-grid-(\d+)/);if(idMatch&&idMatch.length>=3){const resortId=idMatch[1],webcamIndex=parseInt(idMatch[2]),resort=data.find((r=>r.id===resortId));if(resort){const webcams=resort.links||resort.webcams||[];if(webcams[webcamIndex])return sanitizeForFilename(webcams[webcamIndex].name)}}}const activeSubmenuItem=document.querySelector(".submenu-item.active");if(activeSubmenuItem&&!activeSubmenuItem.classList.contains("submenu-item-status"))return sanitizeForFilename(activeSubmenuItem.textContent.trim());const inlineTitle=document.querySelector(".content-section.active .inline-title.inline-title-submenu");if(inlineTitle&&inlineTitle.textContent)return sanitizeForFilename(inlineTitle.textContent.trim());const hash=window.location.hash.substring(1);if(hash){const parts=hash.split("/");if(parts.length>1){const resortId=parts[0],webcamId=parts[1];if(resortId&&webcamId&&!isNaN(parseInt(webcamId))){const resort=data.find((r=>r.id===resortId));if(resort){const webcams=resort.links||resort.webcams||[],webcamIndex=parseInt(webcamId);if(webcams[webcamIndex])return sanitizeForFilename(webcams[webcamIndex].name)}}}}const card=element.closest(".video-card");if(card){const cardTitle=card.querySelector("h3");if(cardTitle)return sanitizeForFilename(cardTitle.textContent.trim())}return"webcam"}function formatTimestamp(){const now=new Date;return`${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}_${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}:${String(now.getSeconds()).padStart(2,"0")}`}function sanitizeForFilename(name){return name.replace(/[^가-힣\w\s,()-]/g,"").replace(/\s+/g,"_")}function downloadImage(dataURL,filename){const link=document.createElement("a");link.href=dataURL,link.download=filename,link.style.display="none",document.body.appendChild(link),link.click(),document.body.removeChild(link)}function closeSidebar(){window.innerWidth<=768&&(sidebar.classList.remove("active"),sidebarBackdrop.classList.remove("active"))}toggleMenu.addEventListener("click",(function(){sidebar.classList.toggle("active"),sidebarBackdrop.classList.toggle("active")})),sidebarBackdrop.addEventListener("click",closeSidebar),window.addEventListener("resize",(function(){isMobile=window.innerWidth<=768,window.innerWidth>768&&(sidebar.classList.remove("active"),sidebarBackdrop.classList.remove("active"))})),window.addEventListener("hashchange",handleHashChange),function(){let initialWeatherDataPromise=Promise.resolve(null);window.location.hash&&(initialWeatherDataPromise=fetch("weather.json?v="+(new Date).getTime()).then((response=>response.ok?response.json():(console.warn("Weather data not available"),null))).then((weatherResult=>weatherResult?(weatherData=weatherResult,weatherResult):null)).catch((error=>(console.error("Error loading weather data:",error),null)))),fetch("links.json?v="+(new Date).getTime()).then((response=>{if(!response.ok)throw new Error("Network response was not ok");return response.json()})).then((responseData=>{if(Array.isArray(responseData)&&responseData.length>0)return data=resorts=responseData,sidebar.innerHTML='<div class="site-title"><a href="./">Slopes cam</a></div>',document.getElementById("default-message"),Array.from(document.querySelectorAll(".content-section:not(#default-message)")).forEach((el=>el.remove())),resorts.forEach((resort=>{const resortId=resort.id,resortName=resort.name,webcams=resort.links||resort.webcams||[],hasSubmenu=webcams.length>0;if(0===webcams.length)return;const menuItemContainer=document.createElement("div");menuItemContainer.className="menu-item-container";const menuItem=document.createElement("div");if(menuItem.className="menu-item",menuItem.setAttribute("data-target",resortId),hasSubmenu&&(menuItem.setAttribute("data-has-submenu","true"),menuItem.setAttribute("data-resort-id",resortId)),menuItem.textContent=resortName,menuItemContainer.appendChild(menuItem),hasSubmenu){const dropdownToggle=document.createElement("span");dropdownToggle.className="dropdown-toggle",dropdownToggle.innerHTML='<i class="bi bi-chevron-down"></i>',dropdownToggle.setAttribute("aria-label","Toggle submenu"),menuItem.appendChild(dropdownToggle),dropdownToggle.addEventListener("click",(function(e){e.preventDefault(),e.stopPropagation();const submenu=menuItemContainer.querySelector(".submenu");if(submenu){const isActive=submenu.classList.contains("active");hideAllSubmenus(),isActive||(submenu.classList.add("active"),menuItem.classList.add("active"),this.innerHTML='<i class="bi bi-chevron-up"></i>')}}))}sidebar.appendChild(menuItemContainer);const contentSection=document.createElement("div");contentSection.className="content-section",contentSection.id=hasSubmenu?`${resortId}-main`:resortId;const contentTitle=document.createElement("h2");if(contentTitle.textContent=resortName,contentTitle.className="inline-title",contentSection.appendChild(contentTitle),mainContent.appendChild(contentSection),hasSubmenu){const submenu=document.createElement("div");if(submenu.className="submenu",submenu.id=`${resortId}-submenu`,menuItemContainer.appendChild(submenu),resort.status){const statusItem=document.createElement("div");statusItem.className="submenu-item submenu-item-status",statusItem.innerHTML='오픈현황 <i class="bi bi-box-arrow-up-right me-1"></i>',submenu.appendChild(statusItem),statusItem.addEventListener("click",(function(){window.open(resort.status,"_blank","noopener,noreferrer")}))}webcams.forEach(((webcam,index)=>{const webcamName=webcam.name;if(!webcamName)return;const submenuItem=document.createElement("div");submenuItem.className="submenu-item",submenuItem.setAttribute("data-target",`${resortId}-webcam-${index}`),submenuItem.setAttribute("data-webcam-index",index),submenuItem.textContent=webcamName,submenu.appendChild(submenuItem);const webcamSection=document.createElement("div");webcamSection.className="content-section",webcamSection.id=`${resortId}-webcam-${index}`;const webcamTitle=document.createElement("h2");webcamTitle.textContent=webcamName,webcamTitle.className="inline-title inline-title-submenu cursor-pointer",webcamTitle.addEventListener("click",(function(){const submenuItem=document.querySelector(`#${resortId}-submenu .submenu-item[data-webcam-index="${index}"]`);submenuItem&&submenuItem.click()})),webcamSection.appendChild(webcamTitle);const resortLabel=document.createElement("span");resortLabel.textContent=resortName,resortLabel.className="resort-label",webcamSection.appendChild(resortLabel);const videoContainer=document.createElement("div");videoContainer.className="video-container",webcamSection.appendChild(videoContainer),mainContent.appendChild(webcamSection),submenuItem.addEventListener("click",(function(){const webcamIndex=this.getAttribute("data-webcam-index");activeWebcam=webcamIndex,updateUrlHash(resortId,webcamIndex),updatePageTitle(resortId,webcamIndex),document.querySelectorAll(".submenu-item").forEach((item=>{item.classList.remove("active")})),this.classList.add("active"),document.querySelectorAll(".content-section").forEach((section=>{section.classList.remove("active")}));const defaultMessage=document.getElementById("default-message");defaultMessage.classList.remove("active"),defaultMessage.style.display="none";const targetSection=document.getElementById(this.getAttribute("data-target"));if(targetSection){targetSection.classList.add("active"),disposeAllPlayers();const videoContainer=targetSection.querySelector(".video-container");if(videoContainer&&webcams[webcamIndex]){const videoUrl=webcams[webcamIndex].video||webcams[webcamIndex].link;if(videoUrl){const player=createVideoPlayer(videoUrl,videoContainer,`${resortId}-${webcamIndex}`,webcams[webcamIndex].video_type);player&&activePlayers.push(player),updateWeatherDisplay(resortId)}else videoContainer.innerHTML='<div class="error-message">No video stream available</div>'}}closeSidebar()}))}))}menuItem.addEventListener("click",(function(e){if(e.target.classList.contains("dropdown-toggle")||e.target.closest(".dropdown-toggle"))return;const target=this.getAttribute("data-target"),hasSubmenu="true"===this.getAttribute("data-has-submenu"),resortId=this.getAttribute("data-resort-id");if(resortId&&(activeResort=resortId,activeWebcam=null),updateUrlHash(target),updatePageTitle(target,null),document.querySelectorAll(".menu-item").forEach((mi=>mi.classList.remove("active"))),document.querySelectorAll(".submenu-item").forEach((smi=>smi.classList.remove("active"))),this.classList.add("active"),hideAllSubmenus(),hasSubmenu){const submenu=document.getElementById(`${target}-submenu`);if(submenu){submenu.classList.add("active"),this.classList.add("active");const dropdownToggle=this.querySelector(".dropdown-toggle");dropdownToggle&&(dropdownToggle.innerHTML='<i class="bi bi-chevron-up"></i>')}}disposeAllPlayers(),document.querySelectorAll(".content-section").forEach((section=>{section.classList.remove("active")}));const defaultMessage=document.getElementById("default-message");if(defaultMessage.classList.remove("active"),defaultMessage.style.display="none",hasSubmenu){const mainSection=document.getElementById(`${target}-main`);mainSection&&(mainSection.classList.add("active"),loadAllWebcams(target))}else{const targetSection=document.getElementById(target);targetSection&&targetSection.classList.add("active")}updateWeatherDisplay(target),closeSidebar()}))})),!window.location.hash&&data.length>0||window.location.hash&&handleHashChange(),initialWeatherDataPromise.then((existingWeatherData=>existingWeatherData||fetch("weather.json?v="+(new Date).getTime()).then((response=>response.ok?response.json():(console.warn("Weather data not available"),null)))));throw new Error("Invalid data format");var resorts})).then((weatherResult=>{if(weatherResult){if(weatherData=weatherResult,console.log("Weather data loaded:",weatherData.length,"locations"),window.location.hash){const resortId=window.location.hash.substring(1).split("/")[0];resortId&&updateWeatherDisplay(resortId)}updateAllResortsWeather()}window.location.hash?handleHashChange():updateFavoritesDisplay()})).catch((error=>{console.error("Error initializing app:",error);const defaultMessage=document.getElementById("default-message");defaultMessage?(defaultMessage.innerHTML='<div class="error-message p-5 text-center"><h3>리조트 정보를 불러오지 못했습니다.</h3><p>페이지를 새로고침하세요.</p></div>',defaultMessage.classList.add("active")):mainContent.innerHTML='<div class="error-message">리조트 정보를 불러오지 못했습니다.</div>'}))}()}));