<!DOCTYPE html>
<html data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Slopes cam - 전국 스키장 실시간 웹캠 모음</title>
  <meta name="description" content="전국 스키장 실시간 웹캠 및 날씨">
  <meta name="keywords" content="스키장, 웹캠, 실시간, 날씨">
  <meta name="author" content="hletrd">

  <meta property="og:title" content="Slopes cam - 전국 스키장 실시간 웹캠 모음">
  <meta property="og:description" content="전국 스키장 실시간 웹캠 및 날씨">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://ski.atik.kr">
  <meta property="og:locale" content="ko_KR">
  <meta property="og:image" content="http://ski.atik.kr/preview.png">
  <meta property="og:image:width" content="2400">
  <meta property="og:image:height" content="1260">
  <meta property="og:image:type" content="image/png">
  <meta property="og:image:alt" content="Weather of ski resorts">
  <meta property="og:site_name" content="Slopes cam - 전국 스키장 실시간 웹캠 모음">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Slopes cam - 전국 스키장 실시간 웹캠 모음">
  <meta name="twitter:description" content="전국 스키장 실시간 웹캠 및 날씨">
  <meta name="twitter:image" content="http://ski.atik.kr/preview.png">

  <meta name="theme-color" content="#121212">

  <meta name="application-name" content="Slopes cam">
  <meta name="msapplication-TileColor" content="#121212">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Slopes cam">

  <link rel="icon" type="image/png" sizes="16x16" href="icons/skiing-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="icons/skiing-32x32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="icons/skiing-64x64.png">
  <link rel="icon" type="image/png" sizes="128x128" href="icons/skiing-128x128.png">
  <link rel="icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="icons/skiing-180x180.png">
  <link rel="manifest" href="manifest.json">

  <meta name="mobile-web-app-capable" content="yes">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/video.js@8.22.0/dist/video-js.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/@videojs/themes@1/dist/forest/index.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <link rel="stylesheet" href="main.css?v=2025041403">
</head>
<body>
  <div class="mobile-nav">
    <div class="mobile-nav-inner">
      <button class="toggle-menu btn">☰</button>
      <div class="mobile-title"><a href="./">Slopes cam</a></div>
      <div style="width: 24px;"></div>
    </div>
  </div>

  <button id="infoButton" class="info-button">
    <i class="bi bi-file-earmark-text"></i>
  </button>

  <div id="infoModal" class="info-modal">
    <div class="info-content">
      <button class="info-close" id="closeInfoModal"><i class="bi bi-x"></i></button>
      <h4 class="info-title">Slopes cam</h4>
      <div class="info-text">
        <p>Q. 일부 영상이 재생되지 않거나 오류가 있습니다.</p>
        <p>A. 각 영상은 스키장에서 제공하는 실시간 웹캠 영상입니다.</p>
        <ul>
          <li>스키장에 따라 영상 제공 방식이 상이하므로 재생 방식이 다를 수 있습니다.</li>
          <li>스키장의 상황에 따라 일부 영상이 제공되지 않거나 변경될 수 있습니다.</li>
          <li>모바일에서는 동시에 재생 가능한 영상의 수에 제한이 있을 수 있으며, 전체보기가 되지 않을 수 있습니다.</li>
          <li>오투리조트는 외부 링크에서의 영상 재생이 막혀 있어 링크만을 제공합니다.</li>
          <li>에덴밸리는 영상 중계 서비스에 결제를 하지 않은 것 같습니다.</li>
          <li>비발디파크는 영상 스트리밍 구현이 매우 특이하게 되어 있어서 한 페이지에 여러 스트림을 넣을 수가 없습니다.</li>
          <li>지산은 24/25시즌 영상 서비스를 중단했습니다.</li>
        </ul>
        <p>Q. 날씨 정보가 정확하지 않습니다.</p>
        <p>A. 날씨 정보는 실시간 관측 정보를 바탕으로 3차원 모델을 통해 계산된 정보입니다.</p>
        <ul>
          <li>날씨 정보는 국지적인 정보를 정확히 반영하지 않을 수 있으며, 부정확한 정보를 포함할 수 있습니다.</li>
          <li>풍속은 10분 풍속, 강수량은 1시간 강수량이며, 적설량은 3시간 적설량입니다.</li>
        </ul>
        <p>Q. 왜 만든 건가요?</p>
        <p>A. 스키장 영상을 바로 모아볼 수 있는 페이지가 없어서 만들었습니다. 날씨도요.</p>
        <ul>
          <li>스키장 공식 홈페이지에서 제공하는 영상은 모바일에서 보기가 불편했습니다. 스키를 타면서 노트북을 들고 다니지는 않잖아요?</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="sidebar-backdrop"></div>

  <div class="sidebar">
    <div class="site-title"><a href="./">Slopes cam</a></div>
  </div>

  <div class="main-content">
    <div id="default-message" class="content-section content-section-default">
      <div class="text-center p-4">
        <h2>전국 스키장 실시간 웹캠 모음</h2>
        <p class="lead" style="font-size: 1.1rem;">왼쪽 메뉴에서 스키장 또는 카메라를 선택하세요.</p>
        <p class="disclaimer mt-2" style="font-size: 0.8rem;">
          사이트 관련 문의 및 기능 제안: <a href="mailto:01@0101010101.com">01@0101010101.com</a>
        </p>
        <p class="lead github-buttons">
          <iframe src="https://ghbtns.com/github-btn.html?user=hletrd&repo=slopes&type=star&count=true" frameborder="0" scrolling="0" width="60" height="20" title="GitHub"></iframe><iframe src="https://ghbtns.com/github-btn.html?user=hletrd&type=follow&count=true" frameborder="0" scrolling="0" width="120" height="20" title="Follow @hletrd on GitHub"></iframe>
        </p>
      </div>
      <div id="favorites-container" class="favorites-section" style="display: none;">
        <h3 class="bookmarks-title">북마크한 영상</h3>
        <div id="favorites-grid" class="favorites-grid"></div>
      </div>
    </div>
  </div>

  <div class="footer">
    이 서비스는 스키장에서 공식적으로 제공하는 서비스가 아닙니다. 관련하여 스키장에 문의하지 마세요.
  </div>

  <button id="addToHomeButton" class="add-to-home">
    <i class="bi bi-plus-square"></i>
  </button>

  <div id="installationModal" class="installation-modal">
    <button class="modal-close" id="closeModal"><i class="bi bi-x"></i></button>
    <h4>홈 화면에 추가</h4>
    <div class="installation-steps">
      <div id="iOSInstructions">
        <p><strong>iPhone</strong></p>
        <ol>
          <li>Safari 브라우저에서 공유 버튼 <i class="bi bi-box-arrow-up"></i> 탭</li>
          <li>"홈 화면에 추가" 선택</li>
          <li>"추가" 버튼 탭</li>
        </ol>
      </div>
      <div id="androidInstructions">
        <p><strong>Android</strong></p>
        <ol>
          <li>Chrome 메뉴 <i class="bi bi-three-dots-vertical"></i> 탭</li>
          <li>"앱 설치" 또는 "홈 화면에 추가" 선택</li>
        </ol>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/video.js@8.22.0/dist/video.min.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        if (isLocalhost) {
          navigator.serviceWorker.getRegistrations().then(function(registrations) {
            for (let registration of registrations) {
              registration.unregister();
            }
          });
        } else {
          navigator.serviceWorker.register('./service-worker.js')
            .then(function(registration) {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            })
            .catch(function(error) {
              console.log('ServiceWorker registration failed: ', error);
            });
        }
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      const toggleMenu = document.querySelector('.toggle-menu');
      const sidebar = document.querySelector('.sidebar');
      const sidebarBackdrop = document.querySelector('.sidebar-backdrop');
      const mainContent = document.querySelector('.main-content');
      const basicTitle = "Slopes cam";
      let activePlayers = [];
      let activeResort = null;
      let activeWebcam = null;
      let data = [];
      let weatherData = [];
      let isMobile = window.innerWidth <= 768;
      let favorites = loadFavorites();

      function loadFavorites() {
        try {
          const favoritesData = localStorage.getItem('webcamFavorites');
          return favoritesData ? JSON.parse(favoritesData) : [];
        } catch (e) {
          console.error('Error loading favorites:', e);
          return [];
        }
      }

      function saveFavorites() {
        try {
          localStorage.setItem('webcamFavorites', JSON.stringify(favorites));
        } catch (e) {
          console.error('Error saving favorites:', e);
        }
      }

      function isFavorite(resortId, webcamIndex) {
        return favorites.some(f => f.resortId === resortId && f.webcamIndex === webcamIndex);
      }

      function toggleFavorite(resortId, webcamIndex, webcamName, videoUrl, videoType) {
        const index = favorites.findIndex(f => f.resortId === resortId && f.webcamIndex === webcamIndex);

        if (index === -1) {
          favorites.push({
            resortId,
            webcamIndex,
            webcamName,
            resortName: data.find(r => r.id === resortId)?.name || '',
            videoUrl,
            videoType
          });
        } else {
          favorites.splice(index, 1);
        }

        saveFavorites();
        updateFavoriteButtons();
        updateFavoritesDisplay();
      }

      function updateFavoriteButtons() {
        document.querySelectorAll('.bookmark-button').forEach(btn => {
          const resortId = btn.getAttribute('data-resort-id');
          const webcamIndex = parseInt(btn.getAttribute('data-webcam-index'));

          if (isFavorite(resortId, webcamIndex)) {
            btn.classList.add('active');
            btn.querySelector('.bookmark-icon').innerHTML = '<i class="bi bi-bookmark-fill"></i>';
          } else {
            btn.classList.remove('active');
            btn.querySelector('.bookmark-icon').innerHTML = '<i class="bi bi-bookmark"></i>';
          }
        });
      }

      function updateFavoritesDisplay() {
        const favoritesContainer = document.getElementById('favorites-container');
        const favoritesGrid = document.getElementById('favorites-grid');

        if (!favoritesContainer || !favoritesGrid) {
          console.error("Favorites container or grid not found");
          return;
        }

        if (favorites.length === 0) {
          const instruction = document.createElement('div');
          instruction.className = 'instruction';
          instruction.innerHTML = '<p>북마크한 영상이 없습니다. 영상 오른쪽 위의 북마크 버튼을 눌러 영상을 추가해 보세요.</p>';
          favoritesContainer.appendChild(instruction);
        }

        favoritesContainer.style.display = 'block';
        favoritesGrid.innerHTML = '';

        if (window.location.hash === '') {
          const favoritesSection = favoritesContainer.closest('.content-section');
          if (favoritesSection) {
            favoritesSection.style.display = 'block';
          }
        } else {
          const favoritesSection = favoritesContainer.closest('.content-section');
          if (favoritesSection) {
            favoritesSection.style.display = 'none';
          }
        }

        if (activePlayers && activePlayers.length > 0) {
          activePlayers = activePlayers.filter(player => {
            const id = player.el_?.id;
            if (id && id.includes('favorite-player')) {
              player.dispose();
              return false;
            }
            return true;
          });
        }

        favorites.forEach((favorite, idx) => {
          const videoCard = document.createElement('div');
          videoCard.className = 'video-card favorite-card';
          videoCard.draggable = true;
          videoCard.setAttribute('data-index', idx);

          const dragHandle = document.createElement('div');
          dragHandle.className = 'drag-handle';
          dragHandle.innerHTML = '<i class="bi bi-grip-vertical"></i>';
          videoCard.appendChild(dragHandle);

          const headerContainer = document.createElement('div');
          headerContainer.className = 'favorites-header-container';

          const header = document.createElement('div');
          header.className = 'favorite-header';

          const locationName = document.createElement('span');
          locationName.className = 'favorite-location';
          locationName.textContent = favorite.webcamName;

          const resortName = document.createElement('span');
          resortName.className = 'favorite-resort';
          resortName.textContent = favorite.resortName;

          header.appendChild(locationName);
          header.appendChild(resortName);
          headerContainer.appendChild(header);

          const removeButton = document.createElement('button');
          removeButton.className = 'favorites-remove-button';
          removeButton.innerHTML = '<i class="bi bi-trash"></i>';
          removeButton.setAttribute('title', '북마크 제거');
          removeButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleFavorite(favorite.resortId, favorite.webcamIndex);
          });

          headerContainer.appendChild(removeButton);
          videoCard.appendChild(headerContainer);

          const videoContainer = document.createElement('div');
          videoContainer.className = 'video-container';
          videoCard.appendChild(videoContainer);

          favoritesGrid.appendChild(videoCard);

          if (favorite.videoUrl) {
            const playerId = `favorite-player-${idx}`;
            const player = createVideoPlayer(
              favorite.videoUrl,
              videoContainer,
              playerId,
              favorite.videoType
            );
            if (player) activePlayers.push(player);
          }

          videoCard.addEventListener('dragstart', handleDragStart);
          videoCard.addEventListener('dragover', handleDragOver);
          videoCard.addEventListener('dragenter', handleDragEnter);
          videoCard.addEventListener('dragleave', handleDragLeave);
          videoCard.addEventListener('drop', handleDrop);
          videoCard.addEventListener('dragend', handleDragEnd);
        });

        updateAllResortsWeather();
      }

      let draggedItem = null;
      let dragSourceIndex = -1;

      function handleDragStart(e) {
        draggedItem = this;
        dragSourceIndex = parseInt(this.getAttribute('data-index'));

        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);

        this.classList.add('dragging');

        document.querySelectorAll('.favorite-card').forEach(card => {
          if (card !== this) {
            card.classList.add('drop-target');
          }
        });
      }

      function handleDragOver(e) {
        if (e.preventDefault) {
          e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        return false;
      }

      function handleDragEnter(e) {
        this.classList.add('drag-over');
      }

      function handleDragLeave(e) {
        this.classList.remove('drag-over');
      }

      function handleDrop(e) {
        e.stopPropagation();
        e.preventDefault();

        this.classList.remove('drag-over');

        if (draggedItem === this) {
          return false;
        }

        const dropTargetIndex = parseInt(this.getAttribute('data-index'));

        if (dragSourceIndex !== -1 && dropTargetIndex !== -1) {
          const itemToMove = favorites[dragSourceIndex];

          favorites.splice(dragSourceIndex, 1);

          favorites.splice(dropTargetIndex, 0, itemToMove);

          saveFavorites();

          updateFavoritesDisplay();
        }

        return false;
      }

      function handleDragEnd(e) {
        const favoriteCards = document.querySelectorAll('.favorite-card');
        favoriteCards.forEach(card => {
          card.classList.remove('dragging', 'drag-over', 'drop-target');
        });
      }

      function createLocationNameDiv(data, timestamp, displaySource = false) {
        const locationNameDiv = document.createElement('div');
        locationNameDiv.className = 'location-name';
        if (data.name.startsWith('리조트_')) {
          locationNameDiv.textContent = data.name.replace('리조트_', '');
        } else {
          locationNameDiv.textContent = data.name;
        }

        if (timestamp) {
          const date = new Date(timestamp);
          month = date.getMonth() + 1;
          day = date.getDate();
          hours = date.getHours().toString().padStart(2, '0');
          minutes = date.getMinutes().toString().padStart(2, '0');

          const timeSpan = document.createElement('span');
          timeSpan.className = 'weather-update-time';
          timeSpan.textContent = `${month}월 ${day}일 ${hours}:${minutes} 기준`;
          if (displaySource) {
            if (data.name.startsWith('리조트_')) {
              timeSpan.textContent += ` (리조트 제공)`;
            } else {
              timeSpan.textContent += ` (기상청 제공)`;
            }
          }
          locationNameDiv.appendChild(timeSpan);
        }

        return locationNameDiv;
      }

      function createWeatherDataDiv(data) {
        const weatherDataDiv = document.createElement('div');
        weatherDataDiv.className = 'weather-data';

        class WeatherMetric {
          constructor(className, iconClass, value, unit, decimals = 1) {
            this.span = document.createElement('span');
            this.span.className = className;

            const icon = document.createElement('i');
            icon.className = iconClass;
            this.span.appendChild(icon);

            const formattedValue = Number(value).toFixed(decimals);
            this.span.appendChild(document.createTextNode(`${formattedValue}${unit}`));

            return this.span;
          }
        }

        if (data.temperature !== null) {
          const tempMetric = new WeatherMetric('temperature', 'bi bi-thermometer-half', data.temperature, '°C');
          weatherDataDiv.appendChild(tempMetric);
        }

        if (data.humidity !== null) {
          weatherDataDiv.appendChild(document.createTextNode(' • '));
          const humidityMetric = new WeatherMetric('humidity', 'bi bi-moisture', data.humidity, '%', 0);
          weatherDataDiv.appendChild(humidityMetric);
        }

        if (data.wind_speed !== null) {
          weatherDataDiv.appendChild(document.createTextNode(' • '));
          const windMetric = new WeatherMetric('wind-speed', 'bi bi-wind', data.wind_speed, 'm/s');
          weatherDataDiv.appendChild(windMetric);
        }

        if (data.rainfall !== null) {
          weatherDataDiv.appendChild(document.createTextNode(' • '));
          const rainfallMetric = new WeatherMetric('rainfall', 'bi bi-droplet-fill', data.rainfall, 'mm');
          weatherDataDiv.appendChild(rainfallMetric);
        }

        if (data.snowfall_3hr !== null) {
          weatherDataDiv.appendChild(document.createTextNode(' • '));
          const snowfallMetric = new WeatherMetric('snowfall', 'bi bi-snow', data.snowfall_3hr, 'cm');
          weatherDataDiv.appendChild(snowfallMetric);
        }

        return weatherDataDiv;
      }

      function updateAllResortsWeather() {
        if (!weatherData || weatherData.length === 0) return;
        if (!data || data.length === 0) return;

        const defaultMessage = document.getElementById('default-message');
        if (!defaultMessage) return;

        const existingWeatherOverview = defaultMessage.querySelector('.all-resorts-weather');
        if (existingWeatherOverview) existingWeatherOverview.remove();

        const allResortsWeatherContainer = document.createElement('div');
        allResortsWeatherContainer.className = 'all-resorts-weather';
        allResortsWeatherContainer.innerHTML = '<h3>전국 스키장 날씨 <span style="font-size: 0.6em; font-weight: normal; color: #999; margin-left: 6px;">기상청 데이터 기준</span></h3>';

        const weatherGrid = document.createElement('div');
        weatherGrid.className = 'weather-container';
        allResortsWeatherContainer.appendChild(weatherGrid);

        data.forEach(resort => {
          const resortName = resort.name;
          const baseAreaWeather = weatherData.find(w => w.resort === resortName && w.name === '스키하우스');

          if (baseAreaWeather && baseAreaWeather.data && baseAreaWeather.data.length > 0) {
            const wrapper = document.createElement('div');
            wrapper.className = 'weather-info-wrapper';

            const weatherInfo = document.createElement('div');
            weatherInfo.className = 'weather-info';

            const mostRecent = baseAreaWeather.data[baseAreaWeather.data.length - 1];

            const locationNameDiv = createLocationNameDiv(resort, baseAreaWeather.timestamp, false);
            const weatherDataDiv = createWeatherDataDiv(mostRecent);

            weatherInfo.appendChild(locationNameDiv);
            weatherInfo.appendChild(weatherDataDiv);

            wrapper.appendChild(weatherInfo);
            weatherGrid.appendChild(wrapper);
          }
        });

        if (weatherGrid.children.length > 0) {
          const favoritesContainer = defaultMessage.querySelector('#favorites-container');
          if (favoritesContainer) {
            favoritesContainer.after(allResortsWeatherContainer);
          } else {
            defaultMessage.appendChild(allResortsWeatherContainer);
          }
        }

        const resortProvidedWeatherTitle = document.createElement('h3');
        resortProvidedWeatherTitle.style.marginTop = '16px';
        resortProvidedWeatherTitle.textContent = '전국 스키장 날씨';
        const resortProvidedWeatherSpan = document.createElement('span');
        resortProvidedWeatherSpan.textContent = '리조트 데이터 기준';
        resortProvidedWeatherSpan.style.fontSize = '0.6em';
        resortProvidedWeatherSpan.style.fontWeight = 'normal';
        resortProvidedWeatherSpan.style.color = '#999';
        resortProvidedWeatherSpan.style.marginLeft = '6px';
        resortProvidedWeatherTitle.appendChild(resortProvidedWeatherSpan);
        allResortsWeatherContainer.appendChild(resortProvidedWeatherTitle);

        const resortProvidedWeatherGrid = document.createElement('div');
        resortProvidedWeatherGrid.className = 'weather-container';
        allResortsWeatherContainer.appendChild(resortProvidedWeatherGrid);

        data.forEach(resort => {
          const resortName = resort.name;
          const baseAreaWeathers = weatherData.filter(w => w.resort === resortName && w.name.startsWith('리조트_'));

          baseAreaWeathers.forEach(baseAreaWeather => {
          if (baseAreaWeather && baseAreaWeather.data && baseAreaWeather.data.length > 0) {
            const wrapper = document.createElement('div');
            wrapper.className = 'weather-info-wrapper';

              const weatherInfo = document.createElement('div');
              weatherInfo.className = 'weather-info';

              const mostRecent = baseAreaWeather.data[baseAreaWeather.data.length - 1];

              const locationNameDiv = createLocationNameDiv(resort, baseAreaWeather.timestamp, false);
              const weatherDataDiv = createWeatherDataDiv(mostRecent);

              weatherInfo.appendChild(locationNameDiv);
              weatherInfo.appendChild(weatherDataDiv);

              wrapper.appendChild(weatherInfo);
              resortProvidedWeatherGrid.appendChild(wrapper);
            }
          });
        });

        if (resortProvidedWeatherGrid.children.length > 0) {
          const favoritesContainer = defaultMessage.querySelector('#favorites-container');
          if (favoritesContainer) {
            favoritesContainer.after(allResortsWeatherContainer);
          } else {
            defaultMessage.appendChild(allResortsWeatherContainer);
          }
        }
      }

      function hideAllSubmenus() {
        document.querySelectorAll('.submenu').forEach(submenu => {
          submenu.classList.remove('active');
        });
        document.querySelectorAll('.menu-item').forEach(item => {
          if (item.getAttribute('data-has-submenu') === 'true') {
            item.classList.remove('active');
          }
        });
        document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
          toggle.innerHTML = '<i class="bi bi-chevron-down"></i>';
        });
      }

      function updateUrlHash(resort, webcam) {
        const currentHash = window.location.hash.substring(1);
        const newHash = webcam ? `${resort}/${webcam}` : resort;

        if (currentHash === newHash) return;

        const url = new URL(window.location);
        url.hash = newHash;
        history.replaceState(null, '', url);
        updatePageTitle(resort, webcam);
      }

      function updatePageTitle(resortId, webcamId) {
        if (!resortId) {
          document.title = basicTitle;
          return;
        }

        const resort = data.find(r => r.id === resortId);
        if (!resort) {
          document.title = basicTitle;
          return;
        }

        if (webcamId !== undefined && webcamId !== null) {
          const webcamIndex = parseInt(webcamId);
          const webcams = resort.links || resort.webcams || [];

          if (!isNaN(webcamIndex) && webcams[webcamIndex]) {
            const webcamName = webcams[webcamIndex].name;
            document.title = `${basicTitle} - ${webcamName} - ${resort.name}`;
          } else {
            document.title = `${basicTitle} - ${resort.name}`;
          }
        } else {
          document.title = `${basicTitle} - ${resort.name}`;
        }
      }

      function disposeAllPlayers() {
        if (activePlayers && activePlayers.length > 0) {
          activePlayers.forEach(player => {
            if (player && typeof player.dispose === 'function') {
              player.dispose();
            }
          });
          activePlayers = [];
        }
      }

      function updateWeatherDisplay(resortId) {
        if (!weatherData || weatherData.length === 0) return;

        const resort = data.find(r => r.id === resortId);
        if (!resort) return;

        const resortName = resort.name;
        const resortWeather = weatherData.filter(w => w.resort === resortName);

        if (resortWeather.length === 0) return;

        const sections = document.querySelectorAll(`.content-section[id^="${resortId}"]`);

        sections.forEach(section => {
          const existingWeather = section.querySelector('.weather-container');
          if (existingWeather) existingWeather.remove();

          const weatherContainer = document.createElement('div');
          weatherContainer.className = 'weather-container';

          resortWeather.forEach(locationData => {
            if (!locationData || !locationData.data || locationData.data.length === 0) return;

            const mostRecent = locationData.data[locationData.data.length - 1];

            const weatherInfoWrapper = document.createElement('div');
            weatherInfoWrapper.className = 'weather-info-wrapper';

            const weatherInfo = document.createElement('div');
            weatherInfo.className = 'weather-info';

            const locationNameDiv = createLocationNameDiv(locationData, locationData.timestamp, true);
            const weatherDataDiv = createWeatherDataDiv(mostRecent);

            weatherInfo.appendChild(locationNameDiv);
            weatherInfo.appendChild(weatherDataDiv);

            weatherInfoWrapper.appendChild(weatherInfo);
            weatherContainer.appendChild(weatherInfoWrapper);
          });

          const videosGrid = section.querySelector('.videos-grid');
          const videoContainer = section.querySelector('.video-container');

          if (videosGrid) {
            videosGrid.after(weatherContainer);
          } else if (videoContainer) {
            videoContainer.after(weatherContainer);
          } else {
            const title = section.querySelector('h2');
            if (title) {
              title.after(weatherContainer);
            } else {
              section.appendChild(weatherContainer);
            }
          }
        });
      }

      function handleHashChange() {
        const hash = window.location.hash.substring(1);
        if (!hash) {
          document.querySelectorAll('.content-section').forEach(section => {
            section.classList.remove('active');
          });
          const defaultMessage = document.getElementById('default-message');
          defaultMessage.classList.add('active');
          defaultMessage.style.display = 'block';
          updateFavoritesDisplay();
          document.title = basicTitle;
          return;
        }

        if (window.processingHashChange) return;
        window.processingHashChange = true;

        try {
          const parts = hash.split('/');
          const resortId = parts[0];
          const webcamId = parts[1];

          updatePageTitle(resortId, webcamId);

          const defaultMessage = document.getElementById('default-message');
          defaultMessage.classList.remove('active');
          defaultMessage.style.display = 'none';

          const resortMenuItem = document.querySelector(`.menu-item[data-target="${resortId}"]`);
          if (resortMenuItem) {
            document.querySelectorAll('.menu-item').forEach(mi => mi.classList.remove('active'));
            resortMenuItem.classList.add('active');

            hideAllSubmenus();

            disposeAllPlayers();

            document.querySelectorAll('.content-section').forEach(section => {
              section.classList.remove('active');
            });

            const hasSubmenu = resortMenuItem.getAttribute('data-has-submenu') === 'true';
            if (hasSubmenu) {
              const submenu = document.getElementById(`${resortId}-submenu`);
              if (submenu) {
                submenu.classList.add('active');
              }

              if (webcamId) {
                const webcamIndex = parseInt(webcamId);
                if (!isNaN(webcamIndex)) {
                  const webcamItem = document.querySelector(`#${resortId}-submenu .submenu-item[data-webcam-index="${webcamIndex}"]`);
                  if (webcamItem) {
                    document.querySelectorAll('.submenu-item').forEach(item => {
                      item.classList.remove('active');
                    });
                    webcamItem.classList.add('active');

                    const targetSection = document.getElementById(webcamItem.getAttribute('data-target'));
                    if (targetSection) {
                      targetSection.classList.add('active');

                      const videoContainer = targetSection.querySelector('.video-container');
                      if (videoContainer) {
                        const resort = data.find(r => r.id === resortId);
                        if (resort) {
                          const webcams = resort.links || resort.webcams || [];
                          if (webcams[webcamIndex]) {
                            const videoUrl = webcams[webcamIndex].video || webcams[webcamIndex].link;
                            if (videoUrl) {
                              const player = createVideoPlayer(videoUrl, videoContainer, `${resortId}-${webcamIndex}`, webcams[webcamIndex].video_type);
                              if (player) activePlayers.push(player);

                              addBookmarkButton(
                                videoContainer,
                                resortId,
                                webcamIndex,
                                webcams[webcamIndex].name,
                                videoUrl,
                                webcams[webcamIndex].video_type
                              );

                              updateWeatherDisplay(resortId);
                            } else {
                              videoContainer.innerHTML = '<div class="error-message">No video stream available</div>';
                            }
                          } else {
                            videoContainer.innerHTML = '<div class="error-message">No video stream available</div>';
                          }
                        }
                      }
                    }
                  }
                }
              } else {
                const mainSection = document.getElementById(`${resortId}-main`);
                if (mainSection) {
                  mainSection.classList.add('active');

                  loadAllWebcams(resortId);
                }
              }

              const dropdownToggle = resortMenuItem.querySelector('.dropdown-toggle');
              if (dropdownToggle) {
                dropdownToggle.innerHTML = '<i class="bi bi-chevron-up"></i>';
              }
            } else {
              const targetSection = document.getElementById(resortId);
              if (targetSection) {
                targetSection.classList.add('active');
              }
            }

            if (weatherData && weatherData.length > 0) {
              updateWeatherDisplay(resortId);
            } else {
              fetch('weather.json?v=' + new Date().getTime())
                .then(response => {
                  if (!response.ok) {
                    console.warn('Weather data not available');
                    return null;
                  }
                  return response.json();
                })
                .then(data => {
                  if (data) {
                    weatherData = data;
                    console.log('Weather data loaded:', weatherData.length, 'locations');
                    updateWeatherDisplay(resortId);
                  }
                })
                .catch(error => {
                  console.error('Error loading weather data:', error);
                });
            }
          }
        } finally {
          setTimeout(() => {
            window.processingHashChange = false;
            updateFavoriteButtons();
          }, 100);
        }
      }

      function loadAllWebcams(resortId) {
        const resort = data.find(r => r.id === resortId);
        if (!resort) return;

        const webcams = resort.links || resort.webcams || [];
        if (webcams.length === 0) return;

        const mainSection = document.getElementById(`${resortId}-main`);
        if (!mainSection) return;

        let videosGrid = mainSection.querySelector('.videos-grid');
        if (!videosGrid) {
          videosGrid = document.createElement('div');
          videosGrid.className = 'videos-grid';

          const title = mainSection.querySelector('h2');
          if (title) {
            title.after(videosGrid);
          } else {
            mainSection.appendChild(videosGrid);
          }
        }

        videosGrid.innerHTML = '';

        webcams.forEach((webcam, index) => {
          const videoUrl = webcam.video || webcam.link;
          if (!videoUrl) return;

          const videoCard = document.createElement('div');
          videoCard.className = 'video-card';

          const cardTitle = document.createElement('h3');
          cardTitle.textContent = webcam.name;
          videoCard.appendChild(cardTitle);

          const videoContainer = document.createElement('div');
          videoContainer.className = 'video-container';
          videoCard.appendChild(videoContainer);

          videosGrid.appendChild(videoCard);

          const player = createVideoPlayer(videoUrl, videoContainer, `${resortId}-grid-${index}`, webcam.video_type);
          if (player) activePlayers.push(player);

          addBookmarkButton(
            videoContainer,
            resortId,
            index,
            webcam.name,
            videoUrl,
            webcam.video_type
          );
        });

        updateFavoriteButtons();

        updateWeatherDisplay(resortId);
      }

      function initializeResorts(resorts) {
        data = resorts;

        sidebar.innerHTML = '<div class="site-title"><a href="./">Slopes cam</a></div>';
        const defaultContent = document.getElementById('default-message');
        const otherContent = Array.from(document.querySelectorAll('.content-section:not(#default-message)'));
        otherContent.forEach(el => el.remove());

        resorts.forEach(resort => {
          const resortId = resort.id;
          const resortName = resort.name;
          const webcams = resort.links || resort.webcams || [];
          const hasSubmenu = webcams.length > 0;

          if (webcams.length === 0) {
            return;
          }

          const menuItemContainer = document.createElement('div');
          menuItemContainer.className = 'menu-item-container';

          const menuItem = document.createElement('div');
          menuItem.className = 'menu-item';
          menuItem.setAttribute('data-target', resortId);
          if (hasSubmenu) {
            menuItem.setAttribute('data-has-submenu', 'true');
            menuItem.setAttribute('data-resort-id', resortId);
          }
          menuItem.textContent = resortName;
          menuItemContainer.appendChild(menuItem);

          if (hasSubmenu) {
            const dropdownToggle = document.createElement('span');
            dropdownToggle.className = 'dropdown-toggle';
            dropdownToggle.innerHTML = '<i class="bi bi-chevron-down"></i>';
            dropdownToggle.setAttribute('aria-label', 'Toggle submenu');
            menuItem.appendChild(dropdownToggle);

            dropdownToggle.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              const submenu = menuItemContainer.querySelector('.submenu');
              if (submenu) {
                const isActive = submenu.classList.contains('active');

                hideAllSubmenus();

                if (!isActive) {
                  submenu.classList.add('active');
                  menuItem.classList.add('active');
                  this.innerHTML = '<i class="bi bi-chevron-up"></i>';
                }
              }

              const resortId = menuItem.getAttribute('data-target');
              if (resortId) {
                updateUrlHash(resortId);
                document.querySelectorAll('.content-section').forEach(section => {
                  section.classList.remove('active');
                });
                const defaultMessage = document.getElementById('default-message');
                defaultMessage.classList.remove('active');
                defaultMessage.style.display = 'none';

                const mainSection = document.getElementById(`${resortId}-main`);
                if (mainSection) {
                  mainSection.classList.add('active');

                  disposeAllPlayers();
                  loadAllWebcams(resortId);
                }

                closeSidebar();
              }
            });
          }

          sidebar.appendChild(menuItemContainer);

          const contentSection = document.createElement('div');
          contentSection.className = 'content-section';
          contentSection.id = hasSubmenu ? `${resortId}-main` : resortId;

          const contentTitle = document.createElement('h2');
          contentTitle.textContent = resortName;
          contentTitle.className = 'inline-title';
          contentSection.appendChild(contentTitle);

          mainContent.appendChild(contentSection);

          if (hasSubmenu) {
            const submenu = document.createElement('div');
            submenu.className = 'submenu';
            submenu.id = `${resortId}-submenu`;
            menuItemContainer.appendChild(submenu);

            if (resort.status) {
              const statusItem = document.createElement('div');
              statusItem.className = 'submenu-item submenu-item-status';
              statusItem.innerHTML = '오픈현황 <i class="bi bi-box-arrow-up-right me-1"></i>';
              submenu.appendChild(statusItem);

              statusItem.addEventListener('click', function() {
                window.open(resort.status, '_blank', 'noopener,noreferrer');
              });
            }

            webcams.forEach((webcam, index) => {
              const webcamName = webcam.name;
              if (!webcamName) return;

              const submenuItem = document.createElement('div');
              submenuItem.className = 'submenu-item';
              submenuItem.setAttribute('data-target', `${resortId}-webcam-${index}`);
              submenuItem.setAttribute('data-webcam-index', index);
              submenuItem.textContent = webcamName;
              submenu.appendChild(submenuItem);

              const webcamSection = document.createElement('div');
              webcamSection.className = 'content-section';
              webcamSection.id = `${resortId}-webcam-${index}`;

              const webcamTitle = document.createElement('h2');
              webcamTitle.textContent = webcamName;
              webcamTitle.className = 'inline-title inline-title-submenu';
              webcamSection.appendChild(webcamTitle);

              const resortLabel = document.createElement('span');
              resortLabel.textContent = resortName;
              resortLabel.className = 'resort-label';
              webcamSection.appendChild(resortLabel);

              const videoContainer = document.createElement('div');
              videoContainer.className = 'video-container';
              webcamSection.appendChild(videoContainer);

              mainContent.appendChild(webcamSection);

              submenuItem.addEventListener('click', function() {
                const webcamIndex = this.getAttribute('data-webcam-index');
                activeWebcam = webcamIndex;

                updateUrlHash(resortId, webcamIndex);
                updatePageTitle(resortId, webcamIndex);

                document.querySelectorAll('.submenu-item').forEach(item => {
                  item.classList.remove('active');
                });
                this.classList.add('active');

                document.querySelectorAll('.content-section').forEach(section => {
                  section.classList.remove('active');
                });

                const defaultMessage = document.getElementById('default-message');
                defaultMessage.classList.remove('active');
                defaultMessage.style.display = 'none';

                const targetSection = document.getElementById(this.getAttribute('data-target'));
                if (targetSection) {
                  targetSection.classList.add('active');

                  disposeAllPlayers();

                  const videoContainer = targetSection.querySelector('.video-container');
                  if (videoContainer && webcams[webcamIndex]) {
                    const videoUrl = webcams[webcamIndex].video || webcams[webcamIndex].link;
                    if (videoUrl) {
                      const player = createVideoPlayer(videoUrl, videoContainer, `${resortId}-${webcamIndex}`, webcams[webcamIndex].video_type);
                      if (player) activePlayers.push(player);

                      updateWeatherDisplay(resortId);
                    } else {
                      videoContainer.innerHTML = '<div class="error-message">No video stream available</div>';
                    }
                  }
                }

                closeSidebar();
              });
            });
          }

          menuItem.addEventListener('click', function(e) {
            if (e.target.classList.contains('dropdown-toggle') || e.target.closest('.dropdown-toggle')) {
              return;
            }

            const target = this.getAttribute('data-target');
            const hasSubmenu = this.getAttribute('data-has-submenu') === 'true';
            const resortId = this.getAttribute('data-resort-id');

            if (resortId) {
              activeResort = resortId;
              activeWebcam = null;
            }

            updateUrlHash(target);
            updatePageTitle(target, null);

            document.querySelectorAll('.menu-item').forEach(mi => mi.classList.remove('active'));
            this.classList.add('active');

            hideAllSubmenus();

            if (hasSubmenu) {
              const submenu = document.getElementById(`${target}-submenu`);
              if (submenu) {
                submenu.classList.add('active');

                const dropdownToggle = this.querySelector('.dropdown-toggle');
                if (dropdownToggle) {
                  dropdownToggle.innerHTML = '<i class="bi bi-chevron-up"></i>';
                }
              }
            }

            disposeAllPlayers();

            document.querySelectorAll('.content-section').forEach(section => {
              section.classList.remove('active');
            });

            const defaultMessage = document.getElementById('default-message');
            defaultMessage.classList.remove('active');
            defaultMessage.style.display = 'none';

            if (hasSubmenu) {
              const mainSection = document.getElementById(`${target}-main`);
              if (mainSection) {
                mainSection.classList.add('active');

                loadAllWebcams(target);
              }
            } else {
              const targetSection = document.getElementById(target);
              if (targetSection) {
                targetSection.classList.add('active');
              }
            }

            updateWeatherDisplay(target);

            closeSidebar();
          });
        });

        if (!window.location.hash && data.length > 0) {
          return;
        }

        if (window.location.hash) {
          handleHashChange();
        }
      }

      function createVideoPlayer(videoUrl, container, id, videoType) {
        container.innerHTML = '';

        const idParts = id.split('-');
        const resortId = idParts[0];
        let webcamIndex = parseInt(idParts[1]);

        if (idParts.length === 3 && idParts[1] === 'grid') {
          webcamIndex = parseInt(idParts[2]);
        }

        let webcamName = '';
        if (resortId && !isNaN(webcamIndex)) {
          const resort = data.find(r => r.id === resortId);
          if (resort) {
            const webcams = resort.links || resort.webcams || [];
            if (webcams[webcamIndex]) {
              webcamName = webcams[webcamIndex].name || '';
            }
          }
        }

        if (videoType === 'vivaldi') {
          const vivaldiContainerId = `vivaldi-player-${id}`;
          const vivaldiContainer = document.createElement('div');
          vivaldiContainer.className = 'iframe-container';

          const vivaldiParams = videoUrl.split(':');
          if (vivaldiParams.length === 2) {
            const channel = vivaldiParams[0];
            const serial = vivaldiParams[1];

            vivaldiContainer.innerHTML = `<iframe src="vivaldi.html?channel=${channel}&serial=${serial}" allowfullscreen></iframe>`;
            container.appendChild(vivaldiContainer);

            if (resortId && !isNaN(webcamIndex)) {
              addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType, 4);
            }

            return {
              dispose: function() {
                container.innerHTML = '';
              }
            };
          } else {
            container.innerHTML = '<div class="error-message">Invalid vivaldi video URL format. Expected: "channel:serial"</div>';
            return null;
          }
        }

        if (videoType === 'iframe') {
          const iframeContainer = document.createElement('div');
          iframeContainer.className = 'iframe-container';
          iframeContainer.innerHTML = `<iframe src="${videoUrl}" allowfullscreen></iframe>`;
          container.appendChild(iframeContainer);

          if (resortId && !isNaN(webcamIndex)) {
            addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType, 2);
          }

          return {
            dispose: function() {
              container.innerHTML = '';
            }
          };
        }

        if (videoType === 'youtube') {
          const youtubeContainer = document.createElement('div');
          youtubeContainer.className = 'iframe-container';

          const youtubeId = getYoutubeId(videoUrl);
          if (youtubeId) {
            youtubeContainer.innerHTML = `<iframe src="https://www.youtube.com/embed/${youtubeId}?autoplay=1&mute=1" allowfullscreen></iframe>`;
            container.appendChild(youtubeContainer);

            if (resortId && !isNaN(webcamIndex)) {
              addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType, 3);
            }

            return {
              dispose: function() {
                container.innerHTML = '';
              }
            };
          }
        }

        if (videoType === 'link') {
          const linkContainer = document.createElement('div');
          linkContainer.className = 'd-flex justify-content-center align-items-center link-container';

          const linkButton = document.createElement('a');
          linkButton.href = videoUrl;
          linkButton.target = '_blank';
          linkButton.rel = 'noopener noreferrer';
          linkButton.className = 'btn btn-primary btn-lg';
          linkButton.innerHTML = `
            <i class="bi bi-box-arrow-up-right me-2"></i>
            외부 링크
          `;

          linkContainer.appendChild(linkButton);
          container.appendChild(linkContainer);

          if (resortId && !isNaN(webcamIndex)) {
            addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType, 2);
          }

          return {
            dispose: function() {
              container.innerHTML = '';
            }
          };
        }

        const resort = getResortAndWebcamFromId(id);
        let linkUrl = null;
        if (resort && resort.webcam && resort.webcam.link) {
          linkUrl = resort.webcam.link;
        }

        container.innerHTML = `
          <video
            id="webcam-player-${id}"
            class="video-js vjs-theme-forest vjs-big-play-centered"
            controls
            autoplay
            muted
            playsinline
          >
            <source src="${videoUrl}" type="application/x-mpegURL">
            <p class="vjs-no-js">
              최신 브라우저를 사용하세요.
            </p>
          </video>
        `;

        try {
          const player = videojs(`webcam-player-${id}`, {
            liveui: true,
            responsive: true,
            fluid: false,
            liveTracker: {
              trackingThreshold: 0,
              liveTolerance: 15
            }
          });

          const captureBtn = document.createElement('button');
          captureBtn.className = 'capture-button';
          captureBtn.innerHTML = `
            <i class="bi bi-camera"></i>
            캡처
          `;
          captureBtn.addEventListener('click', () => captureVideoFrame(player));
          container.appendChild(captureBtn);

          if (document.pictureInPictureEnabled || (document.exitPictureInPicture && document.requestPictureInPicture)) {
            const pipBtn = document.createElement('button');
            pipBtn.className = 'pip-button';
            pipBtn.innerHTML = `
              <i class="bi bi-pip"></i>
              PIP
            `;
            pipBtn.addEventListener('click', () => togglePictureInPicture(player));
            container.appendChild(pipBtn);
          }

          if (resortId && !isNaN(webcamIndex)) {
            addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType);
          }

          player.on('error', function() {
            const error = player.error();
            console.error('Video player error:', error);

            let directLink = null;
            if (resort && resort.webcam) {
              directLink = resort.webcam.link || null;
            } else {
              const resortData = data.find(r => r.id === resortId);
              if (resortData) {
                const webcams = resortData.links || resortData.webcams || [];
                if (webcams[webcamIndex] && webcams[webcamIndex].link) {
                  directLink = webcams[webcamIndex].link;
                }
              }
            }

            let errorHtml = '<div class="error-message"><p>비디오 재생 중 오류가 발생했습니다.</p>';

            if (directLink) {
              errorHtml += `<div class="mt-3">
                <a href="${directLink}" target="_blank" rel="noopener noreferrer" class="btn btn-primary">
                  <i class="bi bi-box-arrow-up-right me-2"></i>
                  원본 링크에서 보기
                </a>
              </div>`;
            }

            errorHtml += '</div>';
            container.innerHTML = errorHtml;

            if (resortId && !isNaN(webcamIndex)) {
              addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType, 1);
            }
          });

          return player;
        } catch (e) {
          console.error('Error creating video player:', e);
          container.innerHTML = '<div class="error-message">비디오 플레이어를 생성하는 중 오류가 발생했습니다.</div>';

          if (resortId && !isNaN(webcamIndex)) {
            addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType, 1);
          }

          return null;
        }
      }

      function togglePictureInPicture(player) {
        const video = player.el().querySelector('video');

        if (!video) return;

        if (document.pictureInPictureElement) {
          document.exitPictureInPicture()
            .catch(error => {
              console.error('Error exiting Picture-in-Picture mode:', error);
            });
        } else if (document.pictureInPictureEnabled || video.requestPictureInPicture) {
          video.requestPictureInPicture()
            .catch(error => {
              console.error('Error entering Picture-in-Picture mode:', error);
            });
        }
      }

      function addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType, type = 0) {
        if (typeof resortId === 'string' && resortId.includes('favorite-player')) {
          return;
        }

        if (container.querySelector('.bookmark-button')) {
          return;
        }

        const bookmarkBtn = document.createElement('button');
        bookmarkBtn.className = 'bookmark-button';
        bookmarkBtn.setAttribute('data-resort-id', resortId);
        bookmarkBtn.setAttribute('data-webcam-index', webcamIndex);
        bookmarkBtn.innerHTML = `
          <span class="bookmark-icon"><i class="bi bi-bookmark"></i></span>
          북마크
        `;
        bookmarkBtn.addEventListener('click', function() {
          toggleFavorite(
            resortId,
            webcamIndex,
            webcamName,
            videoUrl,
            videoType
          );
        });
        container.appendChild(bookmarkBtn);

        if (type === 1) {
          bookmarkBtn.classList.add('bookmark-button-error');
        } else if (type === 2) {
          bookmarkBtn.classList.add('bookmark-button-link');
        } else if (type === 3) {
          bookmarkBtn.classList.add('bookmark-button-youtube');
        } else if (type === 4) {
          bookmarkBtn.classList.add('bookmark-button-vivaldi');
        }
      }

      function captureVideoFrame(player) {
        try {
          const canvas = document.createElement('canvas');
          const video = player.el().querySelector('video');

          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;

          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          const playerId = player.el().id;
          let resortId, webcamIndex;

          if (playerId) {
            const idParts = playerId.replace('webcam-player-', '').split('-');
            if (idParts.length >= 2) {
              if (idParts[1] === 'grid') {
                resortId = idParts[0];
                webcamIndex = parseInt(idParts[2]);
              } else {
                resortId = idParts[0];
                webcamIndex = parseInt(idParts[1]);
              }

              const resort = data.find(r => r.id === resortId);
              if (resort && !isNaN(webcamIndex)) {
                const webcams = resort.links || resort.webcams || [];
                if (webcams[webcamIndex]) {
                  const resortName = sanitizeForFilename(resort.name);
                  const webcamName = sanitizeForFilename(webcams[webcamIndex].name);
                  const timestamp = formatTimestamp();
                  const filename = `capture_${resortName}_${webcamName}_${timestamp}.jpg`;

                  const dataURL = canvas.toDataURL('image/jpeg');
                  downloadImage(dataURL, filename);

                  const container = player.el().parentNode;
                  const successMsg = document.createElement('div');
                  successMsg.className = 'alert alert-success position-absolute top-0 start-50 translate-middle-x mt-3 success-message';
                  successMsg.textContent = '캡처 완료!';
                  container.appendChild(successMsg);

                  setTimeout(() => {
                    successMsg.remove();
                  }, 2000);

                  return;
                }
              }
            }
          }

          const resortName = getResortNameForCapture();
          const webcamName = getWebcamNameForCapture(player.el());
          const timestamp = formatTimestamp();
          const filename = `capture_${resortName}_${webcamName}_${timestamp}.jpg`;

          const dataURL = canvas.toDataURL('image/jpeg');
          downloadImage(dataURL, filename);

          const container = player.el().parentNode;
          const successMsg = document.createElement('div');
          successMsg.className = 'alert alert-success position-absolute top-0 start-50 translate-middle-x mt-3 success-message';
          successMsg.textContent = '캡처 완료!';
          container.appendChild(successMsg);

          setTimeout(() => {
            successMsg.remove();
          }, 2000);

        } catch (e) {
          console.error('Error capturing frame:', e);
          alert('캡처 중 오류가 발생했습니다.');
        }
      }

      function captureScreenshot(container) {
        try {
          const iframe = container.querySelector('iframe');
          if (!iframe) {
            alert('캡처할 영상을 찾을 수 없습니다.');
            return;
          }

          const parentSection = container.closest('.content-section');
          let resortName, webcamName;

          if (parentSection) {
            const parentId = parentSection.id;
            const idParts = parentId.split('-');

            if (idParts.length >= 3 && idParts[1] === 'webcam') {
              const resortId = idParts[0];
              const webcamIndex = parseInt(idParts[2]);

              const resort = data.find(r => r.id === resortId);
              if (resort && !isNaN(webcamIndex)) {
                const webcams = resort.links || resort.webcams || [];
                if (webcams[webcamIndex]) {
                  resortName = sanitizeForFilename(resort.name);
                  webcamName = sanitizeForFilename(webcams[webcamIndex].name);
                }
              }
            }
          }

          if (!resortName || !webcamName) {
            const hash = window.location.hash.substring(1);
            const parts = hash.split('/');
            if (parts.length > 1) {
              const resortId = parts[0];
              const webcamIdx = parseInt(parts[1]);

              const resort = data.find(r => r.id === resortId);
              if (resort && !isNaN(webcamIdx)) {
                const webcams = resort.links || resort.webcams || [];
                if (webcams[webcamIdx]) {
                  resortName = sanitizeForFilename(resort.name);
                  webcamName = sanitizeForFilename(webcams[webcamIdx].name);
                }
              }
            }
          }

          if (!resortName) {
            resortName = getResortNameForCapture();
          }
          if (!webcamName) {
            webcamName = getWebcamNameForCapture(container);
          }

          const timestamp = formatTimestamp();
          const filename = `capture_${resortName}_${webcamName}_${timestamp}.jpg`;

          html2canvas(container).then(canvas => {
            const dataURL = canvas.toDataURL('image/jpeg');
            downloadImage(dataURL, filename);

            const successMsg = document.createElement('div');
            successMsg.className = 'alert alert-success position-absolute top-0 start-50 translate-middle-x mt-3 success-message';
            successMsg.textContent = '캡처 완료!';
            container.appendChild(successMsg);

            setTimeout(() => {
              successMsg.remove();
            }, 2000);
          });
        } catch (e) {
          console.error('Error capturing screenshot:', e);
          alert('캡처 중 오류가 발생했습니다.');
        }
      }

      function getResortNameForCapture() {
        const videoContainer = document.querySelector('.video-container');
        const favoriteCard = videoContainer?.closest('.video-card');
        if (favoriteCard && document.getElementById('default-message').classList.contains('active')) {
          const favoriteResort = favoriteCard.querySelector('.favorite-resort');
          if (favoriteResort && favoriteResort.textContent) {
            return sanitizeForFilename(favoriteResort.textContent.trim());
          }
        }

        const resortLabel = document.querySelector('.content-section.active .resort-label');
        if (resortLabel && resortLabel.textContent) {
          return sanitizeForFilename(resortLabel.textContent.trim());
        }

        const hash = window.location.hash.substring(1);
        if (hash) {
          const parts = hash.split('/');
          const resortId = parts[0];
          const resort = data.find(r => r.id === resortId);
          if (resort) {
            return sanitizeForFilename(resort.name);
          }
        }

        const activeMenuItem = document.querySelector('.menu-item.active');
        if (activeMenuItem) {
          const menuText = activeMenuItem.textContent.trim().split('\n')[0];
          return sanitizeForFilename(menuText);
        }

        return 'unknown';
      }

      function getWebcamNameForCapture(element) {
        const videoContainer = element.closest('.video-container');
        const favoriteCard = videoContainer?.closest('.video-card');
        if (favoriteCard && document.getElementById('default-message').classList.contains('active')) {
          const favoriteLocation = favoriteCard.querySelector('.favorite-location');
          if (favoriteLocation && favoriteLocation.textContent) {
            return sanitizeForFilename(favoriteLocation.textContent.trim());
          }
        }

        const playerElement = videoContainer.querySelector('.vjs-tech') ||
                             videoContainer.querySelector('iframe') ||
                             videoContainer.querySelector('.vivaldi-container');

        if (playerElement && playerElement.id) {
          const idMatch = playerElement.id.match(/player-([^-]+)-(\d+)/) ||
                         playerElement.id.match(/player-([^-]+)-grid-(\d+)/);

          if (idMatch && idMatch.length >= 3) {
            const resortId = idMatch[1];
            const webcamIndex = parseInt(idMatch[2]);

            const resort = data.find(r => r.id === resortId);
            if (resort) {
              const webcams = resort.links || resort.webcams || [];
              if (webcams[webcamIndex]) {
                return sanitizeForFilename(webcams[webcamIndex].name);
              }
            }
          }
        }

        const activeSubmenuItem = document.querySelector('.submenu-item.active');
        if (activeSubmenuItem && !activeSubmenuItem.classList.contains('submenu-item-status')) {
          return sanitizeForFilename(activeSubmenuItem.textContent.trim());
        }

        const inlineTitle = document.querySelector('.content-section.active .inline-title.inline-title-submenu');
        if (inlineTitle && inlineTitle.textContent) {
          return sanitizeForFilename(inlineTitle.textContent.trim());
        }

        const hash = window.location.hash.substring(1);
        if (hash) {
          const parts = hash.split('/');
          if (parts.length > 1) {
            const resortId = parts[0];
            const webcamId = parts[1];
            if (resortId && webcamId && !isNaN(parseInt(webcamId))) {
              const resort = data.find(r => r.id === resortId);
              if (resort) {
                const webcams = resort.links || resort.webcams || [];
                const webcamIndex = parseInt(webcamId);
                if (webcams[webcamIndex]) {
                  return sanitizeForFilename(webcams[webcamIndex].name);
                }
              }
            }
          }
        }

        const card = element.closest('.video-card');
        if (card) {
          const cardTitle = card.querySelector('h3');
          if (cardTitle) {
            return sanitizeForFilename(cardTitle.textContent.trim());
          }
        }

        return 'webcam';
      }

      function formatTimestamp() {
        const now = new Date();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        return `${month}-${day}_${hours}:${minutes}:${seconds}`;
      }

      function sanitizeForFilename(name) {
        return name
          .replace(/[^가-힣\w\s,()-]/g, '')
          .replace(/\s+/g, '_')
      }

      function downloadImage(dataURL, filename) {
        const link = document.createElement('a');
        link.href = dataURL;
        link.download = filename;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function getResortAndWebcamFromId(id) {
        if (!id || !id.includes('-')) return null;

        const parts = id.split('-');
        if (parts.length < 2) return null;

        const resortId = parts[0];
        let webcamIndex = parseInt(parts[1]);

        if (parts.length === 3 && parts[1] === 'grid') {
          webcamIndex = parseInt(parts[2]);
        }

        if (isNaN(webcamIndex)) return null;

        const resort = data.find(r => r.id === resortId);
        if (!resort) return null;

        const webcams = resort.links || resort.webcams || [];
        if (!webcams[webcamIndex]) return null;

        return {
          resort: resort,
          webcam: webcams[webcamIndex]
        };
      }

      function getYoutubeId(url) {
        const liveRegExp = /^(?:https?:\/\/)?(?:www\.)?youtube\.com\/live\/([^#&?]*).*/;
        const liveMatch = url.match(liveRegExp);
        if (liveMatch && liveMatch[1] && liveMatch[1].length === 11) {
          return liveMatch[1];
        }

        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
      }

      function toggleSidebar() {
        sidebar.classList.toggle('active');
        sidebarBackdrop.classList.toggle('active');
      }

      function closeSidebar() {
        if (window.innerWidth <= 768) {
          sidebar.classList.remove('active');
          sidebarBackdrop.classList.remove('active');
        }
      }

      toggleMenu.addEventListener('click', toggleSidebar);

      sidebarBackdrop.addEventListener('click', closeSidebar);

      window.addEventListener('resize', function() {
        isMobile = window.innerWidth <= 768;
        if (window.innerWidth > 768) {
          sidebar.classList.remove('active');
          sidebarBackdrop.classList.remove('active');
        }
      });

      window.addEventListener('hashchange', handleHashChange);

      function initializeApp() {
        let initialWeatherDataPromise = Promise.resolve(null);

        if (window.location.hash) {
          initialWeatherDataPromise = fetch('weather.json?v=' + new Date().getTime())
            .then(response => {
              if (!response.ok) {
                console.warn('Weather data not available');
                return null;
              }
              return response.json();
            })
            .then(weatherResult => {
              if (weatherResult) {
                weatherData = weatherResult;
                console.log('Weather data loaded:', weatherData.length, 'locations');
                return weatherResult;
              }
              return null;
            })
            .catch(error => {
              console.error('Error loading weather data:', error);
              return null;
            });
        }

        fetch('links.json?v=' + new Date().getTime())
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(responseData => {
            if (Array.isArray(responseData) && responseData.length > 0) {
              initializeResorts(responseData);

              return initialWeatherDataPromise.then(existingWeatherData => {
                if (existingWeatherData) {
                  return existingWeatherData;
                } else {
                  return fetch('weather.json?v=' + new Date().getTime())
                    .then(response => {
                      if (!response.ok) {
                        console.warn('Weather data not available');
                        return null;
                      }
                      return response.json();
                    });
                }
              });
            } else {
              throw new Error('Invalid data format');
            }
          })
          .then(weatherResult => {
            if (weatherResult) {
              weatherData = weatherResult;
              console.log('Weather data loaded:', weatherData.length, 'locations');

              if (window.location.hash) {
                const parts = window.location.hash.substring(1).split('/');
                const resortId = parts[0];
                if (resortId) {
                  updateWeatherDisplay(resortId);
                }
              }

              updateAllResortsWeather();
            }

            if (window.location.hash) {
              handleHashChange();
            } else {
              updateFavoritesDisplay();
            }
          })
          .catch(error => {
            console.error('Error initializing app:', error);
            const defaultMessage = document.getElementById('default-message');
            if (defaultMessage) {
              defaultMessage.innerHTML = '<div class="error-message p-5 text-center"><h3>리조트 정보를 불러오지 못했습니다.</h3><p>페이지를 새로고침하세요.</p></div>';
              defaultMessage.classList.add('active');
            } else {
              mainContent.innerHTML = '<div class="error-message">리조트 정보를 불러오지 못했습니다.</div>';
            }
          });
      }

      initializeApp();
    });
  </script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-TDF3M6JH2R"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-TDF3M6JH2R');
  </script>

  <script src="pwa.js"></script>
</body>
</html>


