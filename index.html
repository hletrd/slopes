<!DOCTYPE html>
<html data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Slopes cam</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/video.js@8.22.0/dist/video-js.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/@videojs/themes@1/dist/forest/index.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body {
      background-color: #121212;
      color: #e0e0e0;
      overflow-x: hidden;
    }
    h2 {
      margin-bottom: 24px;
      font-size: 1.6rem;
    }
    .sidebar {
      width: 250px;
      position: fixed;
      left: 0;
      top: 0;
      height: 100%;
      background-color: #1a1a1a;
      overflow-y: auto;
      transition: 0.3s;
      padding-top: 72px;
      padding-bottom: 50px;
      z-index: 90;
    }
    .main-content {
      margin-left: 250px;
      padding: 15px;
      padding-bottom: 50px;
      transition: 0.3s;
      overflow-x: hidden;
    }
    .menu-item {
      padding: 15px;
      cursor: pointer;
      transition: background-color 0.3s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 600;
      font-size: 1.05rem;
    }
    .menu-item:hover {
      background-color: #333;
    }
    .menu-item.active {
      background-color: #444;
      border-left: 4px solid #0069d9;
    }
    .submenu {
      margin-left: 20px;
      display: none;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-in-out;
      width: calc(100% - 20px);
    }
    .submenu.active {
      display: block;
      max-height: 1000px;
    }
    @media (min-width: 769px) {
      .menu-item-container:hover .submenu {
        display: block;
        max-height: 1000px;
      }
    }
    .submenu-item {
      padding: 10px 15px;
      cursor: pointer;
      transition: background-color 0.3s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .submenu-item:hover {
      background-color: #333;
    }
    .submenu-item.active {
      background-color: #2a2a2a;
      border-left: 2px solid #0069d9;
    }
    .content-section {
      display: none;
      padding: 20px;
      background-color: #1e1e1e;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .content-section.active {
      display: block;
    }
    .resort-image {
      width: 100%;
      max-height: 300px;
      object-fit: cover;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    .page-header {
      padding: 15px;
      background-color: #1e1e1e;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .video-container {
      width: 100%;
      margin-bottom: 0;
      position: relative;
      max-width: 100%;
    }
    .video-js {
      width: 100%;
      height: 0;
      padding-top: 56.25%;
      position: relative;
    }
    .video-js .vjs-tech {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    .iframe-container {
      width: 100%;
      height: 0;
      padding-top: 56.25%;
      position: relative;
      margin-bottom: 20px;
      background-color: #000;
    }
    .iframe-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 0;
    }
    .webcam-info {
      margin-top: 15px;
      padding: 10px;
      background-color: #2a2a2a;
      border-radius: 5px;
    }
    .toggle-menu {
      display: none;
      border: none;
      background: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
    }
    .loading {
      text-align: center;
      padding: 50px;
      font-size: 18px;
    }
    .error-message {
      color: #ff6b6b;
      padding: 16px;
      margin: 0 0;
      background-color: rgba(255, 107, 107, 0.1);
      border-radius: 5px;
    }
    .capture-button {
      position: absolute;
      right: 8px;
      top: 8px;
      z-index: 50;
      background-color: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 8px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: background-color 0.3s;
    }
    .capture-button:hover {
      background-color: rgba(0, 0, 0, 0.8);
    }
    .bookmark-button {
      position: absolute;
      right: 8px;
      top: 44px;
      z-index: 50;
      background-color: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 8px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: background-color 0.3s;
    }
    .bookmark-button-error {
      top: 16px;
      right: 16px;
    }
    .bookmark-button-link {
      top: 8px;
      right: 8px;
    }
    .bookmark-button:hover {
      background-color: rgba(0, 0, 0, 0.8);
    }
    .bookmark-button.active {
      color: #ffd700;
    }
    .favorites-section {
      margin-top: 30px;
      padding: 15px;
      background-color: #1e1e1e;
      border-radius: 5px;
    }
    .favorites-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
      gap: 20px;
      width: 100%;
      max-width: 100%;
    }
    .favorites-header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 15px 0 0;
    }
    .favorites-remove-button {
      padding: 0;
      font-size: 16px;
      line-height: 1;
      background-color: transparent;
      border: none;
      color: #ddd;
    }
    .favorites-remove-button:hover {
      color: #fff;
      background-color: transparent;
    }
    .site-title {
      padding: 15px;
      font-size: 24px;
      font-weight: bold;
      color: #fff;
      background-color: #222;
      position: fixed;
      top: 0;
      left: 0;
      width: 250px;
      z-index: 100;
      text-align: center;
    }
    .site-title a {
      color: #fff;
      text-decoration: none;
    }
    .videos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
      gap: 20px;
      width: 100%;
      max-width: 100%;
    }
    .video-card {
      background-color: #2a2a2a;
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 0p;
      width: 100%;
      max-width: 100%;
    }
    .video-card h3 {
      padding: 15px;
      margin: 0;
      font-size: 16px;
    }
    .video-card .video-container {
      margin-bottom: 0;
    }
    .video-card .video-js {
      height: 0;
      padding-top: 56.25%;
    }
    .video-card .iframe-container {
      height: 0;
      padding-top: 56.25%;
    }
    .mobile-nav {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: #222;
      color: #fff;
      height: 60px;
      z-index: 100;
      padding: 0 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }
    .mobile-nav-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 100%;
    }
    .mobile-title {
      font-size: 24px;
      font-weight: bold;
    }
    .mobile-title a {
      color: #fff;
      text-decoration: none;
    }
    .sidebar-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 80;
    }
    .menu-item-container {
      position: relative;
    }
    .inline-title {
      display: inline-block;
      font-size: 1.4rem;
      margin-right: 10px;
    }
    .resort-label {
      font-size: 1.1rem;
      color: #888;
      font-weight: normal;
    }
    .link-container {
      height: 250px;
      background-color: #242424;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .success-message {
      z-index: 100;
    }
    .bookmarks-title {
      font-size: 1.4rem;
      margin-bottom: 16px;
    }
    .content-section-default {
      padding: 8px;
    }
    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: rgba(33, 33, 33, 0.9);
      color: #aaa;
      text-align: center;
      padding: 10px;
      font-size: 0.9rem;
      z-index: 90;
    }
    .github-buttons {
      margin-bottom: -10px;
    }
    @media (max-width: 991px) {
      .videos-grid, .favorites-grid {
        grid-template-columns: 1fr;
        width: 100%;
      }
      .video-js, .iframe-container {
        max-width: 100%;
      }
    }
    @media (max-width: 768px) {
      .mobile-nav {
        display: block;
      }
      .sidebar {
        width: 0;
        padding-top: 16px;
        top: 60px;
        box-shadow: 5px 0 15px rgba(0, 0, 0, 0.2);
      }
      .main-content {
        margin-left: 0;
        margin-top: 60px;
      }
      .sidebar.active {
        width: 250px;
      }
      .toggle-menu {
        display: block;
      }
      .site-title {
        display: none;
      }
      .sidebar-backdrop.active {
        display: block;
      }
      .menu-item-container:hover .submenu {
        display: none;
        max-height: 0;
      }
      .menu-item-container:hover .submenu.active {
        display: block;
        max-height: 1000px;
      }
      .content-section-default {
        padding: 0;
      }
    }
    .weather-info {
      display: inline-block;
      font-size: 0.8rem;
      background-color: rgba(0, 0, 0, 0.2);
      padding: 5px 10px;
      border-radius: 4px;
      margin-left: 10px;
      vertical-align: middle;
      margin-bottom: 5px;
      width: 100%;
    }
    .weather-container {
      display: flex;
      flex-wrap: wrap;
      margin-top: 0;
      margin-bottom: 10px;
      margin-left: -10px;
      margin-right: 10px;
      width: 100%;
    }
    .weather-info-wrapper {
      width: 100%;
      padding: 0 5px;
      margin-bottom: 10px;
    }
    @media (min-width: 576px) {
      .weather-info-wrapper {
        width: 50%;
      }
    }
    @media (min-width: 992px) {
      .weather-info-wrapper {
        width: 33.33%;
      }
    }
    .location-name {
      font-weight: 600;
      margin-bottom: 2px;
      color: #ccc;
    }
    .weather-info i {
      margin-right: 5px;
    }
    .temperature {
      color: #ff9d00;
    }
    .humidity {
      color: #4dabf7;
    }
    .snowfall {
      color: #8ce99a;
    }
  </style>
</head>
<body>
  <div class="mobile-nav">
    <div class="mobile-nav-inner">
      <button class="toggle-menu btn">☰</button>
      <div class="mobile-title"><a href="./">Slopes cam</a></div>
      <div style="width: 24px;"></div>
    </div>
  </div>

  <div class="sidebar-backdrop"></div>

  <div class="sidebar">
    <div class="site-title"><a href="./">Slopes cam</a></div>
  </div>

  <div class="main-content">
    <div id="default-message" class="content-section content-section-default active">
      <div class="text-center p-5">
        <h2>전국 스키장 실시간 웹캠 모음</h2>
        <p class="lead">왼쪽 메뉴에서 스키장 및 카메라를 선택하세요.</p>
        <p class="lead github-buttons">
          <iframe src="https://ghbtns.com/github-btn.html?user=hletrd&repo=slopes&type=star&count=true" frameborder="0" scrolling="0" width="80" height="20" title="GitHub"></iframe>
          <iframe src="https://ghbtns.com/github-btn.html?user=hletrd&type=follow&count=true" frameborder="0" scrolling="0" width="170" height="20" title="Follow @hletrd on GitHub"></iframe>
        </p>
      </div>
      <div id="favorites-container" class="favorites-section" style="display: none;">
        <h3 class="bookmarks-title">북마크된 영상</h3>
        <div id="favorites-grid" class="favorites-grid"></div>
      </div>
    </div>
  </div>

  <div class="footer">
    이 서비스는 스키장에서 공식적으로 제공하는 서비스가 아닙니다. 관련하여 스키장에 문의를 넣지 마세요.
  </div>

  <script src="https://cdn.jsdelivr.net/npm/video.js@8.22.0/dist/video.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const toggleMenu = document.querySelector('.toggle-menu');
      const sidebar = document.querySelector('.sidebar');
      const sidebarBackdrop = document.querySelector('.sidebar-backdrop');
      const mainContent = document.querySelector('.main-content');
      let activePlayers = [];
      let activeResort = null;
      let activeWebcam = null;
      let data = [];
      let weatherData = [];
      let isMobile = window.innerWidth <= 768;
      let favorites = loadFavorites();

      function loadFavorites() {
        try {
          const favoritesData = localStorage.getItem('webcamFavorites');
          return favoritesData ? JSON.parse(favoritesData) : [];
        } catch (e) {
          console.error('Error loading favorites:', e);
          return [];
        }
      }

      function saveFavorites() {
        try {
          localStorage.setItem('webcamFavorites', JSON.stringify(favorites));
        } catch (e) {
          console.error('Error saving favorites:', e);
        }
      }

      function isFavorite(resortId, webcamIndex) {
        return favorites.some(f => f.resortId === resortId && f.webcamIndex === webcamIndex);
      }

      function toggleFavorite(resortId, webcamIndex, webcamName, videoUrl, videoType) {
        const index = favorites.findIndex(f => f.resortId === resortId && f.webcamIndex === webcamIndex);

        if (index === -1) {
          favorites.push({
            resortId,
            webcamIndex,
            webcamName,
            resortName: data.find(r => r.id === resortId)?.name || '',
            videoUrl,
            videoType
          });
        } else {
          favorites.splice(index, 1);
        }

        saveFavorites();
        updateFavoriteButtons();
        updateFavoritesDisplay();
      }

      function updateFavoriteButtons() {
        document.querySelectorAll('.bookmark-button').forEach(btn => {
          const resortId = btn.getAttribute('data-resort-id');
          const webcamIndex = parseInt(btn.getAttribute('data-webcam-index'));

          if (isFavorite(resortId, webcamIndex)) {
            btn.classList.add('active');
            btn.querySelector('.bookmark-icon').innerHTML = '<i class="bi bi-bookmark-fill"></i>';
          } else {
            btn.classList.remove('active');
            btn.querySelector('.bookmark-icon').innerHTML = '<i class="bi bi-bookmark"></i>';
          }
        });
      }

      function updateFavoritesDisplay() {
        const favoritesContainer = document.getElementById('favorites-container');
        const favoritesGrid = document.getElementById('favorites-grid');

        if (!favoritesContainer || !favoritesGrid) {
          console.error("Favorites container or grid not found");
          return;
        }

        if (favorites.length === 0) {
          favoritesContainer.style.display = 'none';
          return;
        }

        favoritesContainer.style.display = 'block';
        favoritesGrid.innerHTML = '';

        if (window.location.hash === '') {
          const favoritesSection = favoritesContainer.closest('.content-section');
          if (favoritesSection) {
            favoritesSection.style.display = 'block';
          }
        } else {
          const favoritesSection = favoritesContainer.closest('.content-section');
          if (favoritesSection) {
            favoritesSection.style.display = 'none';
          }
        }

        if (activePlayers && activePlayers.length > 0) {
          activePlayers = activePlayers.filter(player => {
            const id = player.el_?.id;
            if (id && id.includes('favorite-player')) {
              player.dispose();
              return false;
            }
            return true;
          });
        }

        favorites.forEach((favorite, idx) => {
          const videoCard = document.createElement('div');
          videoCard.className = 'video-card';

          const header = document.createElement('h3');
          header.textContent = `${favorite.resortName} - ${favorite.webcamName}`;

          const headerContainer = document.createElement('div');
          headerContainer.className = 'favorites-header-container';
          headerContainer.appendChild(header);

          const removeButton = document.createElement('button');
          removeButton.className = 'favorites-remove-button';
          removeButton.innerHTML = '<i class="bi bi-trash"></i>';
          removeButton.setAttribute('title', '북마크 제거');
          removeButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleFavorite(favorite.resortId, favorite.webcamIndex);
          });

          headerContainer.appendChild(removeButton);
          videoCard.appendChild(headerContainer);

          const videoContainer = document.createElement('div');
          videoContainer.className = 'video-container';
          videoCard.appendChild(videoContainer);

          favoritesGrid.appendChild(videoCard);

          if (favorite.videoUrl) {
            const playerId = `favorite-player-${idx}`;
            const player = createVideoPlayer(
              favorite.videoUrl,
              videoContainer,
              playerId,
              favorite.videoType
            );
            if (player) activePlayers.push(player);
          }
        });
      }

      function hideAllSubmenus() {
        document.querySelectorAll('.submenu').forEach(submenu => {
          submenu.classList.remove('active');
        });
        document.querySelectorAll('.menu-item').forEach(item => {
          if (item.getAttribute('data-has-submenu') === 'true') {
            item.classList.remove('active');
          }
        });
      }

      function updateUrlHash(resort, webcam) {
        const currentHash = window.location.hash.substring(1);
        const newHash = webcam ? `${resort}/${webcam}` : resort;

        if (currentHash === newHash) return;

        const url = new URL(window.location);
        url.hash = newHash;
        history.replaceState(null, '', url);
      }

      function disposeAllPlayers() {
        if (activePlayers && activePlayers.length > 0) {
          activePlayers.forEach(player => {
            if (player && typeof player.dispose === 'function') {
              player.dispose();
            }
          });
          activePlayers = [];
        }
      }

      function updateWeatherDisplay(resortId) {
        if (!weatherData || weatherData.length === 0) return;

        const resort = data.find(r => r.id === resortId);
        if (!resort) return;

        const resortName = resort.name;
        const resortWeather = weatherData.filter(w => w.resort === resortName);

        if (resortWeather.length === 0) return;

        const sections = document.querySelectorAll(`.content-section[id^="${resortId}"]`);

        sections.forEach(section => {
          const existingWeather = section.querySelector('.weather-container');
          if (existingWeather) existingWeather.remove();

          const title = section.querySelector('h2');
          if (!title) return;

          const weatherContainer = document.createElement('div');
          weatherContainer.className = 'weather-container';

          resortWeather.forEach(locationData => {
            if (!locationData || !locationData.data || locationData.data.length === 0) return;

            const mostRecent = locationData.data[locationData.data.length - 1];

            const weatherInfoWrapper = document.createElement('div');
            weatherInfoWrapper.className = 'weather-info-wrapper';

            const weatherInfo = document.createElement('div');
            weatherInfo.className = 'weather-info';

            weatherInfo.innerHTML = `
               <div class="location-name">${locationData.name}</div>
               <span class="temperature"><i class="bi bi-thermometer-half"></i>${mostRecent.temperature.toFixed(1)}°C</span> &bull;
               <span class="humidity"><i class="bi bi-droplet-half"></i>${mostRecent.humidity.toFixed(0)}%</span> &bull;
               <span class="snowfall"><i class="bi bi-snow"></i>${mostRecent.snowfall_3hr.toFixed(1)}cm</span>
            `;

            weatherInfoWrapper.appendChild(weatherInfo);
            weatherContainer.appendChild(weatherInfoWrapper);
          });

          title.after(weatherContainer);
        });
      }

      function handleHashChange() {
        const hash = window.location.hash.substring(1);
        if (!hash) {
          document.querySelectorAll('.content-section').forEach(section => {
            section.classList.remove('active');
          });
          const defaultMessage = document.getElementById('default-message');
          defaultMessage.classList.add('active');
          defaultMessage.style.display = 'block';
          updateFavoritesDisplay();
          return;
        }

        if (window.processingHashChange) return;
        window.processingHashChange = true;

        try {
          const parts = hash.split('/');
          const resortId = parts[0];
          const webcamId = parts[1];

          const defaultMessage = document.getElementById('default-message');
          defaultMessage.classList.remove('active');
          defaultMessage.style.display = 'none';

          const resortMenuItem = document.querySelector(`.menu-item[data-target="${resortId}"]`);
          if (resortMenuItem) {
            document.querySelectorAll('.menu-item').forEach(mi => mi.classList.remove('active'));
            resortMenuItem.classList.add('active');

            hideAllSubmenus();

            disposeAllPlayers();

            document.querySelectorAll('.content-section').forEach(section => {
              section.classList.remove('active');
            });

            const hasSubmenu = resortMenuItem.getAttribute('data-has-submenu') === 'true';
            if (hasSubmenu) {
              const submenu = document.getElementById(`${resortId}-submenu`);
              if (submenu) {
                submenu.classList.add('active');
              }

              if (webcamId) {
                const webcamIndex = parseInt(webcamId);
                if (!isNaN(webcamIndex)) {
                  const webcamItem = document.querySelector(`#${resortId}-submenu .submenu-item[data-webcam-index="${webcamIndex}"]`);
                  if (webcamItem) {
                    document.querySelectorAll('.submenu-item').forEach(item => {
                      item.classList.remove('active');
                    });
                    webcamItem.classList.add('active');

                    const targetSection = document.getElementById(webcamItem.getAttribute('data-target'));
                    if (targetSection) {
                      targetSection.classList.add('active');

                      const videoContainer = targetSection.querySelector('.video-container');
                      if (videoContainer) {
                        const resort = data.find(r => r.id === resortId);
                        if (resort) {
                          const webcams = resort.links || resort.webcams || [];
                          if (webcams[webcamIndex]) {
                            const videoUrl = webcams[webcamIndex].video || webcams[webcamIndex].link;
                            if (videoUrl) {
                              const player = createVideoPlayer(videoUrl, videoContainer, `${resortId}-${webcamIndex}`, webcams[webcamIndex].video_type);
                              if (player) activePlayers.push(player);

                              addBookmarkButton(
                                videoContainer,
                                resortId,
                                webcamIndex,
                                webcams[webcamIndex].name,
                                videoUrl,
                                webcams[webcamIndex].video_type
                              );
                            } else {
                              videoContainer.innerHTML = '<div class="error-message">No video stream available</div>';
                            }
                          } else {
                            videoContainer.innerHTML = '<div class="error-message">No video stream available</div>';
                          }
                        }
                      }
                    }
                  }
                }
              } else {
                const mainSection = document.getElementById(`${resortId}-main`);
                if (mainSection) {
                  mainSection.classList.add('active');

                  loadAllWebcams(resortId);
                }
              }
            } else {
              const targetSection = document.getElementById(resortId);
              if (targetSection) {
                targetSection.classList.add('active');
              }
            }

            if (weatherData && weatherData.length > 0) {
              updateWeatherDisplay(resortId);
            } else {
              fetch('weather.json?v=' + new Date().getTime())
                .then(response => {
                  if (!response.ok) {
                    console.warn('Weather data not available');
                    return null;
                  }
                  return response.json();
                })
                .then(data => {
                  if (data) {
                    weatherData = data;
                    console.log('Weather data loaded:', weatherData.length, 'locations');
                    updateWeatherDisplay(resortId);
                  }
                })
                .catch(error => {
                  console.error('Error loading weather data:', error);
                });
            }
          }
        } finally {
          setTimeout(() => {
            window.processingHashChange = false;
            updateFavoriteButtons();
          }, 100);
        }
      }

      function loadAllWebcams(resortId) {
        const resort = data.find(r => r.id === resortId);
        if (!resort) return;

        const webcams = resort.links || resort.webcams || [];
        if (webcams.length === 0) return;

        const mainSection = document.getElementById(`${resortId}-main`);
        if (!mainSection) return;

        let videosGrid = mainSection.querySelector('.videos-grid');
        if (!videosGrid) {
          videosGrid = document.createElement('div');
          videosGrid.className = 'videos-grid';

          const title = mainSection.querySelector('h2');
          if (title) {
            title.after(videosGrid);
          } else {
            mainSection.appendChild(videosGrid);
          }
        }

        videosGrid.innerHTML = '';

        webcams.forEach((webcam, index) => {
          const videoUrl = webcam.video || webcam.link;
          if (!videoUrl) return;

          const videoCard = document.createElement('div');
          videoCard.className = 'video-card';

          const cardTitle = document.createElement('h3');
          cardTitle.textContent = webcam.name;
          videoCard.appendChild(cardTitle);

          const videoContainer = document.createElement('div');
          videoContainer.className = 'video-container';
          videoCard.appendChild(videoContainer);

          videosGrid.appendChild(videoCard);

          const player = createVideoPlayer(videoUrl, videoContainer, `${resortId}-grid-${index}`, webcam.video_type);
          if (player) activePlayers.push(player);

          addBookmarkButton(
            videoContainer,
            resortId,
            index,
            webcam.name,
            videoUrl,
            webcam.video_type
          );
        });

        updateFavoriteButtons();
      }

      function initializeResorts(resorts) {
        data = resorts;

        sidebar.innerHTML = '<div class="site-title"><a href="./">Slopes cam</a></div>';
        const defaultContent = document.getElementById('default-message');
        const otherContent = Array.from(document.querySelectorAll('.content-section:not(#default-message)'));
        otherContent.forEach(el => el.remove());

        resorts.forEach(resort => {
          const resortId = resort.id;
          const resortName = resort.name;
          const webcams = resort.links || resort.webcams || [];
          const hasSubmenu = webcams.length > 0;

          const menuItemContainer = document.createElement('div');
          menuItemContainer.className = 'menu-item-container';

          const menuItem = document.createElement('div');
          menuItem.className = 'menu-item';
          menuItem.setAttribute('data-target', resortId);
          if (hasSubmenu) {
            menuItem.setAttribute('data-has-submenu', 'true');
            menuItem.setAttribute('data-resort-id', resortId);
          }
          menuItem.textContent = resortName;
          menuItemContainer.appendChild(menuItem);

          sidebar.appendChild(menuItemContainer);

          const contentSection = document.createElement('div');
          contentSection.className = 'content-section';
          contentSection.id = hasSubmenu ? `${resortId}-main` : resortId;

          const contentTitle = document.createElement('h2');
          contentTitle.textContent = resortName;
          contentTitle.className = 'inline-title';
          contentSection.appendChild(contentTitle);

          mainContent.appendChild(contentSection);

          if (hasSubmenu) {
            const submenu = document.createElement('div');
            submenu.className = 'submenu';
            submenu.id = `${resortId}-submenu`;
            menuItemContainer.appendChild(submenu);

            webcams.forEach((webcam, index) => {
              const webcamName = webcam.name;
              if (!webcamName) return;

              const submenuItem = document.createElement('div');
              submenuItem.className = 'submenu-item';
              submenuItem.setAttribute('data-target', `${resortId}-webcam-${index}`);
              submenuItem.setAttribute('data-webcam-index', index);
              submenuItem.textContent = webcamName;
              submenu.appendChild(submenuItem);

              const webcamSection = document.createElement('div');
              webcamSection.className = 'content-section';
              webcamSection.id = `${resortId}-webcam-${index}`;

              const webcamTitle = document.createElement('h2');
              webcamTitle.textContent = webcamName;
              webcamTitle.className = 'inline-title';
              webcamSection.appendChild(webcamTitle);

              const resortLabel = document.createElement('span');
              resortLabel.textContent = resortName;
              resortLabel.className = 'resort-label';
              webcamSection.appendChild(resortLabel);

              const videoContainer = document.createElement('div');
              videoContainer.className = 'video-container';
              webcamSection.appendChild(videoContainer);

              mainContent.appendChild(webcamSection);

              submenuItem.addEventListener('click', function() {
                const webcamIndex = this.getAttribute('data-webcam-index');
                activeWebcam = webcamIndex;

                updateUrlHash(resortId, webcamIndex);

                document.querySelectorAll('.submenu-item').forEach(item => {
                  item.classList.remove('active');
                });
                this.classList.add('active');

                document.querySelectorAll('.content-section').forEach(section => {
                  section.classList.remove('active');
                });

                const defaultMessage = document.getElementById('default-message');
                defaultMessage.classList.remove('active');
                defaultMessage.style.display = 'none';

                const targetSection = document.getElementById(this.getAttribute('data-target'));
                if (targetSection) {
                  targetSection.classList.add('active');

                  disposeAllPlayers();

                  const videoContainer = targetSection.querySelector('.video-container');
                  if (videoContainer && webcams[webcamIndex]) {
                    const videoUrl = webcams[webcamIndex].video || webcams[webcamIndex].link;
                    if (videoUrl) {
                      const player = createVideoPlayer(videoUrl, videoContainer, `${resortId}-${index}`, webcams[webcamIndex].video_type);
                      if (player) activePlayers.push(player);
                    } else {
                      videoContainer.innerHTML = '<div class="error-message">No video stream available</div>';
                    }
                  }
                }

                closeSidebar();
              });
            });
          }

          menuItem.addEventListener('click', function() {
            const target = this.getAttribute('data-target');
            const hasSubmenu = this.getAttribute('data-has-submenu') === 'true';
            const resortId = this.getAttribute('data-resort-id');

            if (resortId) {
              activeResort = resortId;
              activeWebcam = null;
            }

            updateUrlHash(target);

            document.querySelectorAll('.menu-item').forEach(mi => mi.classList.remove('active'));
            this.classList.add('active');

            if (isMobile && hasSubmenu) {
              const submenu = this.parentNode.querySelector('.submenu');
              if (submenu) {
                const isActive = submenu.classList.contains('active');
                hideAllSubmenus();
                if (!isActive) {
                  submenu.classList.add('active');
                  this.classList.add('active');
                  return;
                }
              }
            } else {
              hideAllSubmenus();

              if (hasSubmenu) {
                const submenu = this.parentNode.querySelector('.submenu');
                if (submenu && !isMobile) {
                  submenu.classList.add('active');
                  this.classList.add('active');
                }
              }
            }

            disposeAllPlayers();

            document.querySelectorAll('.content-section').forEach(section => {
              section.classList.remove('active');
            });

            const defaultMessage = document.getElementById('default-message');
            defaultMessage.classList.remove('active');
            defaultMessage.style.display = 'none';

            if (hasSubmenu) {
              const mainSection = document.getElementById(`${target}-main`);
              if (mainSection) {
                mainSection.classList.add('active');

                loadAllWebcams(target);
              }
            } else {
              const targetSection = document.getElementById(target);
              if (targetSection) {
                targetSection.classList.add('active');
              }
            }

            updateWeatherDisplay(target);

            closeSidebar();
          });
        });

        if (!window.location.hash && data.length > 0) {
          return;
        }

        if (window.location.hash) {
          handleHashChange();
        }
      }

      function createVideoPlayer(videoUrl, container, id, videoType) {
        container.innerHTML = '';

        const idParts = id.split('-');
        const resortId = idParts[0];
        let webcamIndex = parseInt(idParts[1]);

        if (idParts.length === 3 && idParts[1] === 'grid') {
          webcamIndex = parseInt(idParts[2]);
        }

        let webcamName = '';
        if (resortId && !isNaN(webcamIndex)) {
          const resort = data.find(r => r.id === resortId);
          if (resort) {
            const webcams = resort.links || resort.webcams || [];
            if (webcams[webcamIndex]) {
              webcamName = webcams[webcamIndex].name || '';
            }
          }
        }

        if (videoType === 'iframe') {
          const iframeContainer = document.createElement('div');
          iframeContainer.className = 'iframe-container';
          iframeContainer.innerHTML = `<iframe src="${videoUrl}" allowfullscreen></iframe>`;
          container.appendChild(iframeContainer);

          if (resortId && !isNaN(webcamIndex)) {
            addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType, 2);
          }

          return {
            dispose: function() {
              container.innerHTML = '';
            }
          };
        }

        if (videoType === 'youtube') {
          const youtubeContainer = document.createElement('div');
          youtubeContainer.className = 'iframe-container';

          const youtubeId = getYoutubeId(videoUrl);
          if (youtubeId) {
            youtubeContainer.innerHTML = `<iframe src="https://www.youtube.com/embed/${youtubeId}?autoplay=1&mute=1" allowfullscreen></iframe>`;
            container.appendChild(youtubeContainer);

            const captureBtn = document.createElement('button');
            captureBtn.className = 'capture-button';
            captureBtn.innerHTML = `
              <i class="bi bi-camera"></i>
              캡처
            `;
            captureBtn.addEventListener('click', () => captureScreenshot(youtubeContainer));
            container.appendChild(captureBtn);

            if (resortId && !isNaN(webcamIndex)) {
              addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType);
            }

            return {
              dispose: function() {
                container.innerHTML = '';
              }
            };
          }
        }

        if (videoType === 'link') {
          const linkContainer = document.createElement('div');
          linkContainer.className = 'd-flex justify-content-center align-items-center link-container';

          const linkButton = document.createElement('a');
          linkButton.href = videoUrl;
          linkButton.target = '_blank';
          linkButton.rel = 'noopener noreferrer';
          linkButton.className = 'btn btn-primary btn-lg';
          linkButton.innerHTML = `
            <i class="bi bi-box-arrow-up-right me-2"></i>
            외부 링크
          `;

          linkContainer.appendChild(linkButton);
          container.appendChild(linkContainer);

          if (resortId && !isNaN(webcamIndex)) {
            addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType, 2);
          }

          return {
            dispose: function() {
              container.innerHTML = '';
            }
          };
        }

        const resort = getResortAndWebcamFromId(id);
        let linkUrl = null;
        if (resort && resort.webcam && resort.webcam.link) {
          linkUrl = resort.webcam.link;
        }

        container.innerHTML = `
          <video
            id="webcam-player-${id}"
            class="video-js vjs-theme-forest vjs-big-play-centered"
            controls
            autoplay
            muted
            playsinline
          >
            <source src="${videoUrl}" type="application/x-mpegURL">
            <p class="vjs-no-js">
              최신 브라우저를 사용하세요.
            </p>
          </video>
        `;

        try {
          const player = videojs(`webcam-player-${id}`, {
            liveui: true,
            responsive: true,
            fluid: false,
            liveTracker: {
              trackingThreshold: 0,
              liveTolerance: 15
            }
          });

          const captureBtn = document.createElement('button');
          captureBtn.className = 'capture-button';
          captureBtn.innerHTML = `
            <i class="bi bi-camera"></i>
            캡처
          `;
          captureBtn.addEventListener('click', () => captureVideoFrame(player));
          container.appendChild(captureBtn);

          if (resortId && !isNaN(webcamIndex)) {
            addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType);
          }

          player.on('error', function() {
            const error = player.error();

            if (error && error.code === 4 && linkUrl) {
              container.innerHTML = `
                <div class="error-message">
                  <p>직접 스트리밍이 제한되었습니다 (403 Forbidden).</p>
                  <button class="btn btn-primary mt-2" onclick="window.open('${linkUrl}', '_blank')">원본 링크에서 보기</button>
                </div>
              `;

              if (resortId && !isNaN(webcamIndex)) {
                addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType, 1);
              }
            } else {
              container.innerHTML = '<div class="error-message">비디오 재생 중 오류가 발생했습니다.</div>';

              if (resortId && !isNaN(webcamIndex)) {
                addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType, 1);
              }
            }
          });

          return player;
        } catch (e) {
          console.error('Error creating video player:', e);
          container.innerHTML = '<div class="error-message">비디오 플레이어를 생성하는 중 오류가 발생했습니다.</div>';

          if (resortId && !isNaN(webcamIndex)) {
            addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType, 1);
          }

          return null;
        }
      }

      function addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType, type = 0) {
        if (typeof resortId === 'string' && resortId.includes('favorite-player')) {
          return;
        }

        if (container.querySelector('.bookmark-button')) {
          return;
        }

        const bookmarkBtn = document.createElement('button');
        bookmarkBtn.className = 'bookmark-button';
        bookmarkBtn.setAttribute('data-resort-id', resortId);
        bookmarkBtn.setAttribute('data-webcam-index', webcamIndex);
        bookmarkBtn.innerHTML = `
          <span class="bookmark-icon"><i class="bi bi-bookmark"></i></span>
          북마크
        `;
        bookmarkBtn.addEventListener('click', function() {
          toggleFavorite(
            resortId,
            webcamIndex,
            webcamName,
            videoUrl,
            videoType
          );
        });
        container.appendChild(bookmarkBtn);

        if (type === 1) {
          bookmarkBtn.classList.add('bookmark-button-error');
        } else if (type === 2) {
          bookmarkBtn.classList.add('bookmark-button-link');
        }
      }

      function captureVideoFrame(player) {
        try {
          const canvas = document.createElement('canvas');
          const video = player.el().querySelector('video');

          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;

          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          const dataURL = canvas.toDataURL('image/png');
          downloadImage(dataURL, 'webcam-capture.png');

          const container = player.el().parentNode;
          const successMsg = document.createElement('div');
          successMsg.className = 'alert alert-success position-absolute top-0 start-50 translate-middle-x mt-3 success-message';
          successMsg.textContent = '캡처에 성공했습니다.';
          container.appendChild(successMsg);

          setTimeout(() => {
            successMsg.remove();
          }, 2000);

        } catch (e) {
          console.error('Error capturing frame:', e);
          alert('캡처 중 오류가 발생했습니다.');
        }
      }

      function captureScreenshot(container) {
        try {
          const iframe = container.querySelector('iframe');
          if (!iframe) {
            alert('캡처할 콘텐츠를 찾을 수 없습니다.');
            return;
          }

          html2canvas(container).then(canvas => {
            const dataURL = canvas.toDataURL('image/png');
            downloadImage(dataURL, 'webcam-capture.png');

            const successMsg = document.createElement('div');
            successMsg.className = 'alert alert-success position-absolute top-0 start-50 translate-middle-x mt-3 success-message';
            successMsg.textContent = '캡처 완료!';
            container.appendChild(successMsg);

            setTimeout(() => {
              successMsg.remove();
            }, 2000);
          });
        } catch (e) {
          console.error('Error capturing screenshot:', e);
          alert('캡처 중 오류가 발생했습니다.');
        }
      }

      function downloadImage(dataURL, filename) {
        const link = document.createElement('a');
        link.href = dataURL;
        link.download = filename;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function getResortAndWebcamFromId(id) {
        if (!id || !id.includes('-')) return null;

        const parts = id.split('-');
        if (parts.length < 2) return null;

        const resortId = parts[0];
        let webcamIndex = parseInt(parts[1]);

        if (parts.length === 3 && parts[1] === 'grid') {
          webcamIndex = parseInt(parts[2]);
        }

        if (isNaN(webcamIndex)) return null;

        const resort = data.find(r => r.id === resortId);
        if (!resort) return null;

        const webcams = resort.links || resort.webcams || [];
        if (!webcams[webcamIndex]) return null;

        return {
          resort: resort,
          webcam: webcams[webcamIndex]
        };
      }

      function getYoutubeId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
      }

      function toggleSidebar() {
        sidebar.classList.toggle('active');
        sidebarBackdrop.classList.toggle('active');
      }

      function closeSidebar() {
        if (window.innerWidth <= 768) {
          sidebar.classList.remove('active');
          sidebarBackdrop.classList.remove('active');
        }
      }

      toggleMenu.addEventListener('click', toggleSidebar);

      sidebarBackdrop.addEventListener('click', closeSidebar);

      window.addEventListener('resize', function() {
        isMobile = window.innerWidth <= 768;
        if (window.innerWidth > 768) {
          sidebar.classList.remove('active');
          sidebarBackdrop.classList.remove('active');
        }
      });

      window.addEventListener('hashchange', handleHashChange);

      function initializeApp() {
        fetch('links.json?v=' + new Date().getTime())
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(responseData => {
            if (Array.isArray(responseData) && responseData.length > 0) {
              initializeResorts(responseData);

              return fetch('weather.json?v=' + new Date().getTime())
                .then(response => {
                  if (!response.ok) {
                    console.warn('Weather data not available');
                    return null;
                  }
                  return response.json();
                })
                .then(weatherResult => {
                  if (weatherResult) {
                    weatherData = weatherResult;
                    console.log('Weather data loaded:', weatherData.length, 'locations');

                    if (window.location.hash) {
                      const parts = window.location.hash.substring(1).split('/');
                      const resortId = parts[0];
                      if (resortId) {
                        updateWeatherDisplay(resortId);
                      }
                    }
                  }

                  if (window.location.hash) {
                    handleHashChange();
                  } else {
                    updateFavoritesDisplay();
                  }
                });
            } else {
              throw new Error('Invalid data format');
            }
          })
          .catch(error => {
            console.error('Error initializing app:', error);
            const defaultMessage = document.getElementById('default-message');
            if (defaultMessage) {
              defaultMessage.innerHTML = '<div class="error-message p-5 text-center"><h3>리조트 정보를 불러오지 못했습니다.</h3><p>페이지를 새로고침하세요.</p></div>';
              defaultMessage.classList.add('active');
            } else {
              mainContent.innerHTML = '<div class="error-message">리조트 정보를 불러오지 못했습니다.</div>';
            }
          });
      }

      initializeApp();
    });
  </script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</body>
</html>

