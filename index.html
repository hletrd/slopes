<!DOCTYPE html>
<html data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Slopes cam</title>
  <meta name="description" content="전국 스키장 실시간 웹캠 및 날씨">
  <meta name="keywords" content="스키장, 웹캠, 실시간, 날씨">
  <meta name="author" content="hletrd">

  <meta property="og:title" content="Slopes cam">
  <meta property="og:description" content="전국 스키장 실시간 웹캠 및 날씨">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://ski.atik.kr">
  <meta property="og:locale" content="ko_KR">
  <meta property="og:image" content="http://ski.atik.kr/preview.png">
  <meta property="og:image:width" content="2400">
  <meta property="og:image:height" content="1260">
  <meta property="og:image:type" content="image/png">
  <meta property="og:image:alt" content="Weather of ski resorts">
  <meta property="og:site_name" content="Slopes cam">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Slopes cam">
  <meta name="twitter:description" content="전국 스키장 실시간 웹캠 및 날씨">
  <meta name="twitter:image" content="http://ski.atik.kr/preview.png">

  <meta name="theme-color" content="#121212">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Slopes cam">

  <link rel="icon" type="image/svg+xml" href="icons/skiing.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="icons/skiing-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="icons/skiing-16x16.png">
  <link rel="apple-touch-icon" href="icons/skiing-180x180.png">
  <link rel="manifest" href="manifest.json">

  <meta name="mobile-web-app-capable" content="yes">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/video.js@8.22.0/dist/video-js.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/@videojs/themes@1/dist/forest/index.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    body {
      background-color: #121212;
      color: #e0e0e0;
      overflow-x: hidden;
      font-family: "Pretendard Variable", Pretendard, -apple-system, BlinkMacSystemFont, system-ui, Roboto, "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
      font-weight: 350;
    }
    h2 {
      margin-bottom: 24px;
      font-size: 1.6rem;
      font-weight: 800;
    }
    .sidebar {
      width: 250px;
      position: fixed;
      left: 0;
      top: 0;
      height: 100%;
      background-color: #1a1a1a;
      overflow-y: auto;
      transition: 0.3s;
      padding-top: 72px;
      padding-bottom: 50px;
      z-index: 90;
      font-weight: 450;
    }
    .main-content {
      margin-left: 250px;
      padding: 15px;
      padding-bottom: 50px;
      transition: 0.3s;
      overflow-x: hidden;
    }
    .menu-item {
      padding: 15px;
      padding-right: 35px;
      cursor: pointer;
      transition: background-color 0.3s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 650;
      font-size: 1.05rem;
      position: relative;
    }
    .menu-item.active {
      background-color: #444;
      border-left: 4px solid #0069d9;
      padding-left: 11px;
      font-weight: 750;
    }
    .submenu {
      margin-left: 20px;
      display: none;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-in-out;
      width: calc(100% - 20px);
    }
    .submenu.active {
      display: block;
      max-height: 1000px;
    }
    .submenu-item {
      padding: 10px 15px;
      cursor: pointer;
      transition: background-color 0.3s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 450;
    }
    .submenu-item.active {
      background-color: #2a2a2a;
      border-left: 2px solid #0069d9;
      font-weight: 600;
    }
    .content-section {
      display: none;
      padding: 20px;
      padding-bottom: 0;
      background-color: #1e1e1e;
      border-radius: 5px;
      margin-bottom: 8px;
    }
    .content-section.active {
      display: block;
    }
    .resort-image {
      width: 100%;
      max-height: 300px;
      object-fit: cover;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    .page-header {
      padding: 15px;
      background-color: #1e1e1e;
      border-radius: 5px;
      margin-bottom: 20px;
      font-weight: 800;
    }
    .video-container {
      width: 100%;
      margin-bottom: 16px;
      position: relative;
      max-width: 100%;
    }
    .video-js {
      width: 100%;
      height: 0;
      padding-top: 56.25%;
      position: relative;
    }
    .video-js .vjs-tech {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    .iframe-container {
      width: 100%;
      height: 0;
      padding-top: 56.25%;
      position: relative;
      margin-bottom: 20px;
      background-color: #000;
    }
    .iframe-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 0;
    }
    .webcam-info {
      margin-top: 15px;
      padding: 10px;
      background-color: #2a2a2a;
      border-radius: 5px;
      font-weight: 450;
    }
    .toggle-menu {
      display: none;
      border: none;
      background: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      font-weight: 650;
    }
    .loading {
      text-align: center;
      padding: 50px;
      font-size: 18px;
      font-weight: 500;
    }
    .error-message {
      color: #ff6b6b;
      padding: 16px;
      margin: 0 0;
      background-color: rgba(255, 107, 107, 0.1);
      border-radius: 5px;
      font-weight: 550;
    }
    .capture-button {
      position: absolute;
      right: 8px;
      top: 8px;
      z-index: 50;
      background-color: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 8px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: background-color 0.3s;
      font-weight: 550;
    }
    .capture-button:hover {
      background-color: rgba(0, 0, 0, 0.8);
      font-weight: 600;
    }
    .bookmark-button {
      position: absolute;
      right: 8px;
      top: 44px;
      z-index: 50;
      background-color: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 8px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: background-color 0.3s;
      font-weight: 550;
    }
    .bookmark-button:hover {
      background-color: rgba(0, 0, 0, 0.8);
      font-weight: 600;
    }
    .bookmark-button.active {
      color: #ffd700;
      font-weight: 650;
    }
    .favorites-section {
      margin-top: 0;
      padding: 15px;
      background-color: #1e1e1e;
      border-radius: 5px;
    }
    .favorites-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
      gap: 20px;
      width: 100%;
      max-width: 100%;
    }
    .favorites-header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 15px 0 0;
    }
    .favorites-remove-button {
      padding: 0;
      font-size: 16px;
      line-height: 1;
      background-color: transparent;
      border: none;
      color: #ddd;
      font-weight: 400;
    }
    .favorites-remove-button:hover {
      color: #fff;
      background-color: transparent;
      font-weight: 500;
    }
    .site-title {
      padding: 15px;
      font-size: 24px;
      font-weight: 900;
      color: #fff;
      background-color: #222;
      position: fixed;
      top: 0;
      left: 0;
      width: 250px;
      z-index: 100;
      text-align: center;
    }
    .site-title a {
      color: #fff;
      text-decoration: none;
      font-weight: 900;
    }
    .videos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
      gap: 20px;
      width: 100%;
      max-width: 100%;
      margin-bottom: 16px;
    }
    .video-card {
      background-color: #2a2a2a;
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 0p;
      width: 100%;
      max-width: 100%;
    }
    .video-card h3 {
      padding: 15px;
      margin: 0;
      font-size: 16px;
      font-weight: 650;
    }
    .video-card .video-container {
      margin-bottom: 0;
    }
    .video-card .video-js {
      height: 0;
      padding-top: 56.25%;
    }
    .video-card .iframe-container {
      height: 0;
      padding-top: 56.25%;
    }
    .mobile-nav {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: #222;
      color: #fff;
      height: 60px;
      z-index: 100;
      padding: 0 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }
    .mobile-nav-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 100%;
      position: relative;
    }
    .mobile-title {
      font-size: 24px;
      font-weight: 900;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      width: auto;
    }
    .mobile-title a {
      color: #fff;
      text-decoration: none;
      font-weight: 900;
    }
    .sidebar-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 80;
    }
    .menu-item-container {
      position: relative;
    }
    .inline-title {
      display: inline-block;
      font-size: 1.4rem;
      margin-right: 10px;
      line-height: 1.5;
      margin-bottom: 12px;
      font-weight: 800;
    }
    .resort-label {
      font-size: 1.1rem;
      color: #888;
      font-weight: 350;
      line-height: 1.5;
    }
    .link-container {
      height: 250px;
      background-color: #242424;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .success-message {
      z-index: 100;
      font-weight: 550;
    }
    .bookmarks-title {
      font-size: 1.4rem;
      margin-bottom: 16px;
      font-weight: 800;
    }
    .all-resorts-weather {
      margin-top: 16px;
      margin-bottom: 0;
      padding: 12px;
      padding-bottom: 0;
      border-radius: 5px;
    }
    .all-resorts-weather h3 {
      font-size: 1.4rem;
      margin-bottom: 16px;
      margin-left: 4px;
      font-weight: 800;
    }
    .content-section-default {
      padding: 8px;
      padding-bottom: 0;
    }
    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: rgba(33, 33, 33, 0.9);
      color: #aaa;
      text-align: center;
      padding: 10px;
      font-size: 0.9rem;
      z-index: 90;
      font-weight: 375;
    }
    .github-buttons {
      margin-bottom: -10px;
    }
    .info-button {
      position: fixed;
      top: 30px;
      right: 30px;
      background-color: transparent;
      color: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      border: none;
      z-index: 100;
      font-size: 24px;
    }
    .info-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      border-radius: 10px;
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .info-content {
      background-color: #222;
      padding: 25px;
      padding-bottom: 8px;
      border-radius: 5px;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    .info-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: #aaa;
      font-size: 24px;
      cursor: pointer;
    }
    .info-title {
      font-size: 1.2rem;
      margin-bottom: 24px;
      color: white;
      font-weight: 800;
    }
    .info-text {
      color: #ddd;
      margin-top: 15px;
      line-height: 1.3;
      margin-bottom: 0;
      font-weight: 500;
    }
    .info-text p {
      font-weight: 600;
    }
    .info-text li {
      margin-bottom: 10px;
      font-size: 0.9rem;
      font-weight: 425;
    }
    .add-to-home {
      position: fixed;
      bottom: 70px;
      right: 20px;
      background-color: #0069d9;
      color: white;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      display: none;
      justify-content: center;
      align-items: center;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
      z-index: 100;
      cursor: pointer;
      border: none;
      font-weight: 600;
    }
    .add-to-home i {
      font-size: 24px;
      font-weight: 550;
    }
    .installation-modal {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #222;
      color: white;
      padding: 20px;
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
      padding-top: 20px;
      text-align: center;
    }
    .installation-modal h4 {
      font-size: 1.2rem;
      margin-bottom: 20px;
      font-weight: 800;
    }
    .modal-close {
      position: absolute;
      top: 8px;
      right: 10px;
      background: none;
      border: none;
      color: #aaa;
      font-size: 30px;
      cursor: pointer;
      font-weight: 300;
    }
    .installation-steps {
      margin-top: 10px;
      padding: 15px;
      padding-bottom: 10px;
      background-color: #333;
      border-radius: 5px;
      text-align: left;
      line-height: 1.5;
    }
    .installation-steps p {
      font-weight: 600;
    }
    .installation-steps ol {
      margin-left: 20px;
      padding-left: 0;
      margin-bottom: 0;
      font-weight: 425;
    }
    .installation-steps li {
      margin-bottom: 8px;
      font-weight: 425;
    }
    .weather-info {
      display: inline-block;
      font-size: 0.9rem;
      background-color: rgba(0, 0, 0, 0.2);
      padding: 5px 10px;
      border-radius: 4px;
      margin-left: 6px;
      vertical-align: middle;
      margin-bottom: 3px;
      width: 100%;
      font-weight: 425;
    }
    .weather-data {
      font-size: 0.75rem;
      display: block;
      margin-top: 3px;
      font-weight: 425;
    }
    .wind-speed::after {
      content: "";
      display: inline;
    }
    .weather-container {
      display: flex;
      flex-wrap: wrap;
      margin-top: 0;
      padding-bottom: 8px;
      margin-left: -12px;
      width: calc(100% + 10px);
    }
    .weather-info-wrapper {
      width: 100%;
      padding: 0 6px;
      margin-bottom: 6px;
    }
    .location-name {
      font-weight: 700;
      margin-bottom: 2px;
      color: #ccc;
    }
    .weather-update-time {
      font-size: 0.7rem;
      color: #888;
      margin-left: 8px;
      font-weight: 250;
    }
    .weather-info i {
      margin-right: 5px;
      font-weight: 550;
    }
    .temperature {
      color: #ff6b6b;
      font-weight: 600;
    }
    .humidity {
      color: #74c0fc;
      font-weight: 600;
    }
    .wind-speed {
      color: #20c997;
      font-weight: 600;
    }
    .rainfall {
      color: #4dabf7;
      font-weight: 600;
    }
    .snowfall {
      color: #d0ebff;
      font-weight: 600;
    }
    .dropdown-toggle {
      position: absolute;
      right: 10px;
      top: 15px;
      color: #aaa;
      font-size: 18px;
      cursor: pointer;
      transition: color 0.2s;
      background: transparent;
      border: none;
      outline: none;
      appearance: none;
      -webkit-appearance: none;
      padding: 0;
      z-index: 5;
    }
    .dropdown-toggle:hover {
      color: #fff;
    }
    .dropdown-toggle i {
      display: block;
      margin-top: -2px;
      font-weight: 550;
    }
    .dropdown-toggle::after {
      display: none !important;
      content: none !important;
    }
    .dropdown-toggle::before {
      display: none !important;
      content: none !important;
    }
    .favorite-header {
      display: block;
      margin: 0;
      padding: 15px;
      font-size: 16px;
    }
    .favorite-location {
      font-weight: 800;
      display: inline;
    }
    .favorite-resort {
      font-size: 0.85em;
      color: #999;
      font-weight: 350;
      margin-left: 10px;
      display: inline;
    }
    .disclaimer a {
      color: inherit;
      text-decoration: none;
      font-weight: 550;
    }
    .disclaimer {
      font-weight: 375;
      color: #ccc;
    }
    .lead {
      font-weight: 475;
    }
    .btn {
      font-weight: 600;
    }
    .btn-primary {
      font-weight: 650;
    }
    .btn-lg {
      font-weight: 700;
    }
    a {
      font-weight: 500;
    }
    strong {
      font-weight: 700;
    }
    b {
      font-weight: 700;
    }
    .vjs-big-play-button {
      font-weight: 600 !important;
    }
    .vjs-control-bar {
      font-weight: 550 !important;
    }

    @media (min-width: 1024px) {
      .weather-info-wrapper {
        width: 50%;
      }
    }
  </style>
</head>
<body>
  <div class="mobile-nav">
    <div class="mobile-nav-inner">
      <button class="toggle-menu btn">☰</button>
      <div class="mobile-title"><a href="./">Slopes cam</a></div>
      <div style="width: 24px;"></div>
    </div>
  </div>

  <button id="infoButton" class="info-button">
    <i class="bi bi-file-earmark-text"></i>
  </button>

  <div id="infoModal" class="info-modal">
    <div class="info-content">
      <button class="info-close" id="closeInfoModal"><i class="bi bi-x"></i></button>
      <h4 class="info-title">Slopes cam</h4>
      <div class="info-text">
        <p>Q. 일부 영상이 재생되지 않거나 오류가 있습니다.</p>
        <p>A. 각 영상은 스키장에서 제공하는 실시간 웹캠 영상입니다.</p>
        <ul>
          <li>스키장에 따라 영상 제공 방식이 상이하므로 재생 방식이 다를 수 있습니다.</li>
          <li>스키장의 상황에 따라 일부 영상이 제공되지 않을 수 있습니다.</li>
        </ul>
        <p>Q. 날씨 정보가 정확하지 않습니다.</p>
        <p>A. 날씨 정보는 실시간 관측 정보를 바탕으로 3차원 모델을 통해 계산된 정보입니다.</p>
        <ul>
          <li>날씨 정보는 국지적인 정보를 정확히 반영하지 않을 수 있습니다.</li>
          <li>날씨 정보는 부정확한 정보를 포함할 수 있습니다.</li>
          <li>풍속은 10분 풍속, 강수량은 1시간 강수량이며, 적설량은 3시간 적설량입니다.</li>
        </ul>
        <p>Q. 왜 만든 건가요?</p>
        <p>A. 스키장 영상을 바로 모아볼 수 있는 페이지가 없어서 만들었습니다. 날씨도요.</p>
        <ul>
          <li>스키장 공식 홈페이지에서 제공하는 영상은 모바일에서 보기가 불편했습니다. 스키를 타면서 노트북을 들고 다니지는 않잖아요?</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="sidebar-backdrop"></div>

  <div class="sidebar">
    <div class="site-title"><a href="./">Slopes cam</a></div>
  </div>

  <div class="main-content">
    <div id="default-message" class="content-section content-section-default active">
      <div class="text-center p-4">
        <h2>전국 스키장 실시간 웹캠 모음</h2>
        <p class="lead" style="font-size: 1.1rem;">왼쪽 메뉴에서 스키장 또는 카메라를 선택하세요.</p>
        <p class="disclaimer mt-4" style="font-size: 0.8rem;">
          스키장의 상황에 따라 웹캠 영상은 제공되지 않거나 변경될 수 있습니다. 날씨는 기상청 API에서 제공되는 정보로 매 시간 업데이트되며, 부정확한 정보를 포함할 수 있습니다.
          <br>
          모바일에서는 동시에 재생 가능한 영상의 수에 제한이 있을 수 있으며, 전체보기가 되지 않을 수 있습니다.
          <br>
          사이트 관련 문의 및 기능 제안: <a href="mailto:01@0101010101.com">01@0101010101.com</a>
        </p>
        <p class="lead github-buttons">
          <iframe src="https://ghbtns.com/github-btn.html?user=hletrd&repo=slopes&type=star&count=true" frameborder="0" scrolling="0" width="60" height="20" title="GitHub"></iframe><iframe src="https://ghbtns.com/github-btn.html?user=hletrd&type=follow&count=true" frameborder="0" scrolling="0" width="120" height="20" title="Follow @hletrd on GitHub"></iframe>
        </p>
      </div>
      <div id="favorites-container" class="favorites-section" style="display: none;">
        <h3 class="bookmarks-title">북마크된 영상</h3>
        <div id="favorites-grid" class="favorites-grid"></div>
      </div>
    </div>
  </div>

  <div class="footer">
    이 서비스는 스키장에서 공식적으로 제공하는 서비스가 아닙니다. 관련하여 스키장에 문의하지 마세요.
  </div>

  <button id="addToHomeButton" class="add-to-home">
    <i class="bi bi-plus-square"></i>
  </button>

  <div id="installationModal" class="installation-modal">
    <button class="modal-close" id="closeModal"><i class="bi bi-x"></i></button>
    <h4>홈 화면에 추가</h4>
    <div class="installation-steps">
      <div id="iOSInstructions">
        <p><strong>iPhone</strong></p>
        <ol>
          <li>Safari 브라우저에서 공유 버튼 <i class="bi bi-box-arrow-up"></i> 탭</li>
          <li>"홈 화면에 추가" 선택</li>
          <li>"추가" 버튼 탭</li>
        </ol>
      </div>
      <div id="androidInstructions">
        <p><strong>Android</strong></p>
        <ol>
          <li>Chrome 메뉴 <i class="bi bi-three-dots-vertical"></i> 탭</li>
          <li>"앱 설치" 또는 "홈 화면에 추가" 선택</li>
        </ol>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/video.js@8.22.0/dist/video.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const toggleMenu = document.querySelector('.toggle-menu');
      const sidebar = document.querySelector('.sidebar');
      const sidebarBackdrop = document.querySelector('.sidebar-backdrop');
      const mainContent = document.querySelector('.main-content');
      let activePlayers = [];
      let activeResort = null;
      let activeWebcam = null;
      let data = [];
      let weatherData = [];
      let isMobile = window.innerWidth <= 768;
      let favorites = loadFavorites();

      function loadFavorites() {
        try {
          const favoritesData = localStorage.getItem('webcamFavorites');
          return favoritesData ? JSON.parse(favoritesData) : [];
        } catch (e) {
          console.error('Error loading favorites:', e);
          return [];
        }
      }

      function saveFavorites() {
        try {
          localStorage.setItem('webcamFavorites', JSON.stringify(favorites));
        } catch (e) {
          console.error('Error saving favorites:', e);
        }
      }

      function isFavorite(resortId, webcamIndex) {
        return favorites.some(f => f.resortId === resortId && f.webcamIndex === webcamIndex);
      }

      function toggleFavorite(resortId, webcamIndex, webcamName, videoUrl, videoType) {
        const index = favorites.findIndex(f => f.resortId === resortId && f.webcamIndex === webcamIndex);

        if (index === -1) {
          favorites.push({
            resortId,
            webcamIndex,
            webcamName,
            resortName: data.find(r => r.id === resortId)?.name || '',
            videoUrl,
            videoType
          });
        } else {
          favorites.splice(index, 1);
        }

        saveFavorites();
        updateFavoriteButtons();
        updateFavoritesDisplay();
      }

      function updateFavoriteButtons() {
        document.querySelectorAll('.bookmark-button').forEach(btn => {
          const resortId = btn.getAttribute('data-resort-id');
          const webcamIndex = parseInt(btn.getAttribute('data-webcam-index'));

          if (isFavorite(resortId, webcamIndex)) {
            btn.classList.add('active');
            btn.querySelector('.bookmark-icon').innerHTML = '<i class="bi bi-bookmark-fill"></i>';
          } else {
            btn.classList.remove('active');
            btn.querySelector('.bookmark-icon').innerHTML = '<i class="bi bi-bookmark"></i>';
          }
        });
      }

      function updateFavoritesDisplay() {
        const favoritesContainer = document.getElementById('favorites-container');
        const favoritesGrid = document.getElementById('favorites-grid');

        if (!favoritesContainer || !favoritesGrid) {
          console.error("Favorites container or grid not found");
          return;
        }

        if (favorites.length === 0) {
          favoritesContainer.style.display = 'none';
          return;
        }

        favoritesContainer.style.display = 'block';
        favoritesGrid.innerHTML = '';

        if (window.location.hash === '') {
          const favoritesSection = favoritesContainer.closest('.content-section');
          if (favoritesSection) {
            favoritesSection.style.display = 'block';
          }
        } else {
          const favoritesSection = favoritesContainer.closest('.content-section');
          if (favoritesSection) {
            favoritesSection.style.display = 'none';
          }
        }

        if (activePlayers && activePlayers.length > 0) {
          activePlayers = activePlayers.filter(player => {
            const id = player.el_?.id;
            if (id && id.includes('favorite-player')) {
              player.dispose();
              return false;
            }
            return true;
          });
        }

        favorites.forEach((favorite, idx) => {
          const videoCard = document.createElement('div');
          videoCard.className = 'video-card';

          const headerContainer = document.createElement('div');
          headerContainer.className = 'favorites-header-container';

          const header = document.createElement('div');
          header.className = 'favorite-header';

          const locationName = document.createElement('span');
          locationName.className = 'favorite-location';
          locationName.textContent = favorite.webcamName;

          const resortName = document.createElement('span');
          resortName.className = 'favorite-resort';
          resortName.textContent = favorite.resortName;

          header.appendChild(locationName);
          header.appendChild(resortName);
          headerContainer.appendChild(header);

          const removeButton = document.createElement('button');
          removeButton.className = 'favorites-remove-button';
          removeButton.innerHTML = '<i class="bi bi-trash"></i>';
          removeButton.setAttribute('title', '북마크 제거');
          removeButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleFavorite(favorite.resortId, favorite.webcamIndex);
          });

          headerContainer.appendChild(removeButton);
          videoCard.appendChild(headerContainer);

          const videoContainer = document.createElement('div');
          videoContainer.className = 'video-container';
          videoCard.appendChild(videoContainer);

          favoritesGrid.appendChild(videoCard);

          if (favorite.videoUrl) {
            const playerId = `favorite-player-${idx}`;
            const player = createVideoPlayer(
              favorite.videoUrl,
              videoContainer,
              playerId,
              favorite.videoType
            );
            if (player) activePlayers.push(player);
          }
        });

        updateAllResortsWeather();
      }

      function updateAllResortsWeather() {
        if (!weatherData || weatherData.length === 0) return;
        if (!data || data.length === 0) return;

        const defaultMessage = document.getElementById('default-message');
        if (!defaultMessage) return;

        const existingWeatherOverview = defaultMessage.querySelector('.all-resorts-weather');
        if (existingWeatherOverview) existingWeatherOverview.remove();

        const allResortsWeatherContainer = document.createElement('div');
        allResortsWeatherContainer.className = 'all-resorts-weather';
        allResortsWeatherContainer.innerHTML = '<h3>전국 스키장 날씨</h3>';

        const weatherGrid = document.createElement('div');
        weatherGrid.className = 'weather-container';
        allResortsWeatherContainer.appendChild(weatherGrid);

        data.forEach(resort => {
          const resortName = resort.name;
          const baseAreaWeather = weatherData.find(w => w.resort === resortName && w.name === '스키하우스');

          if (baseAreaWeather && baseAreaWeather.data && baseAreaWeather.data.length > 0) {
            const wrapper = document.createElement('div');
            wrapper.className = 'weather-info-wrapper';

            const weatherInfo = document.createElement('div');
            weatherInfo.className = 'weather-info';

            const mostRecent = baseAreaWeather.data[baseAreaWeather.data.length - 1];

            let updateTime = '';
            if (baseAreaWeather.timestamp) {
              const date = new Date(baseAreaWeather.timestamp);
              const month = date.getMonth() + 1;
              const day = date.getDate();
              const hours = date.getHours().toString().padStart(2, '0');
              const minutes = date.getMinutes().toString().padStart(2, '0');
              updateTime = `<span class="weather-update-time">${month}월 ${day}일 ${hours}:${minutes} 기준</span>`;
            }

            weatherInfo.innerHTML = `
              <div class="location-name">${resortName} ${updateTime}</div>
              <div class="weather-data">
                <span class="temperature"><i class="bi bi-thermometer-half"></i>${mostRecent.temperature.toFixed(1)}°C</span> &bull;
                <span class="humidity"><i class="bi bi-moisture"></i>${mostRecent.humidity.toFixed(0)}%</span> &bull;
                <span class="wind-speed"><i class="bi bi-wind"></i>${mostRecent.wind_speed.toFixed(1)}m/s</span> &bull;
                <span class="rainfall"><i class="bi bi-droplet-fill"></i>${mostRecent.rainfall.toFixed(1)}mm</span> &bull;
                <span class="snowfall"><i class="bi bi-snow"></i>${mostRecent.snowfall_3hr.toFixed(1)}cm</span>
              </div>
            `;

            wrapper.appendChild(weatherInfo);
            weatherGrid.appendChild(wrapper);
          }
        });

        if (weatherGrid.children.length > 0) {
          const favoritesContainer = defaultMessage.querySelector('#favorites-container');
          if (favoritesContainer) {
            favoritesContainer.after(allResortsWeatherContainer);
          } else {
            defaultMessage.appendChild(allResortsWeatherContainer);
          }
        }
      }

      function hideAllSubmenus() {
        document.querySelectorAll('.submenu').forEach(submenu => {
          submenu.classList.remove('active');
        });
        document.querySelectorAll('.menu-item').forEach(item => {
          if (item.getAttribute('data-has-submenu') === 'true') {
            item.classList.remove('active');
          }
        });
        document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
          toggle.innerHTML = '<i class="bi bi-chevron-down"></i>';
        });
      }

      function updateUrlHash(resort, webcam) {
        const currentHash = window.location.hash.substring(1);
        const newHash = webcam ? `${resort}/${webcam}` : resort;

        if (currentHash === newHash) return;

        const url = new URL(window.location);
        url.hash = newHash;
        history.replaceState(null, '', url);
      }

      function disposeAllPlayers() {
        if (activePlayers && activePlayers.length > 0) {
          activePlayers.forEach(player => {
            if (player && typeof player.dispose === 'function') {
              player.dispose();
            }
          });
          activePlayers = [];
        }
      }

      function updateWeatherDisplay(resortId) {
        if (!weatherData || weatherData.length === 0) return;

        const resort = data.find(r => r.id === resortId);
        if (!resort) return;

        const resortName = resort.name;
        const resortWeather = weatherData.filter(w => w.resort === resortName);

        if (resortWeather.length === 0) return;

        const sections = document.querySelectorAll(`.content-section[id^="${resortId}"]`);

        sections.forEach(section => {
          const existingWeather = section.querySelector('.weather-container');
          if (existingWeather) existingWeather.remove();

          const weatherContainer = document.createElement('div');
          weatherContainer.className = 'weather-container';

          resortWeather.forEach(locationData => {
            if (!locationData || !locationData.data || locationData.data.length === 0) return;

            const mostRecent = locationData.data[locationData.data.length - 1];

            const weatherInfoWrapper = document.createElement('div');
            weatherInfoWrapper.className = 'weather-info-wrapper';

            const weatherInfo = document.createElement('div');
            weatherInfo.className = 'weather-info';

            let updateTime = '';
            if (locationData.timestamp) {
              const date = new Date(locationData.timestamp);
              const month = date.getMonth() + 1;
              const day = date.getDate();
              const hours = date.getHours().toString().padStart(2, '0');
              const minutes = date.getMinutes().toString().padStart(2, '0');
              updateTime = `<span class="weather-update-time">${month}월 ${day}일 ${hours}:${minutes} 기준</span>`;
            }

            weatherInfo.innerHTML = `
               <div class="location-name">${locationData.name} ${updateTime}</div>
               <div class="weather-data">
                 <span class="temperature"><i class="bi bi-thermometer-half"></i>${mostRecent.temperature.toFixed(1)}°C</span> &bull;
                 <span class="humidity"><i class="bi bi-moisture"></i>${mostRecent.humidity.toFixed(0)}%</span> &bull;
                 <span class="wind-speed"><i class="bi bi-wind"></i>${mostRecent.wind_speed.toFixed(1)}m/s</span> &bull;
                 <span class="rainfall"><i class="bi bi-droplet-fill"></i>${mostRecent.rainfall.toFixed(1)}mm</span> &bull;
                 <span class="snowfall"><i class="bi bi-snow"></i>${mostRecent.snowfall_3hr.toFixed(1)}cm</span>
               </div>
            `;

            weatherInfoWrapper.appendChild(weatherInfo);
            weatherContainer.appendChild(weatherInfoWrapper);
          });

          const videosGrid = section.querySelector('.videos-grid');
          const videoContainer = section.querySelector('.video-container');

          if (videosGrid) {
            videosGrid.after(weatherContainer);
          } else if (videoContainer) {
            videoContainer.after(weatherContainer);
          } else {
            const title = section.querySelector('h2');
            if (title) {
              title.after(weatherContainer);
            } else {
              section.appendChild(weatherContainer);
            }
          }
        });
      }

      function handleHashChange() {
        const hash = window.location.hash.substring(1);
        if (!hash) {
          document.querySelectorAll('.content-section').forEach(section => {
            section.classList.remove('active');
          });
          const defaultMessage = document.getElementById('default-message');
          defaultMessage.classList.add('active');
          defaultMessage.style.display = 'block';
          updateFavoritesDisplay();
          return;
        }

        if (window.processingHashChange) return;
        window.processingHashChange = true;

        try {
          const parts = hash.split('/');
          const resortId = parts[0];
          const webcamId = parts[1];

          const defaultMessage = document.getElementById('default-message');
          defaultMessage.classList.remove('active');
          defaultMessage.style.display = 'none';

          const resortMenuItem = document.querySelector(`.menu-item[data-target="${resortId}"]`);
          if (resortMenuItem) {
            document.querySelectorAll('.menu-item').forEach(mi => mi.classList.remove('active'));
            resortMenuItem.classList.add('active');

            hideAllSubmenus();

            disposeAllPlayers();

            document.querySelectorAll('.content-section').forEach(section => {
              section.classList.remove('active');
            });

            const hasSubmenu = resortMenuItem.getAttribute('data-has-submenu') === 'true';
            if (hasSubmenu) {
              const submenu = document.getElementById(`${resortId}-submenu`);
              if (submenu) {
                submenu.classList.add('active');
              }

              if (webcamId) {
                const webcamIndex = parseInt(webcamId);
                if (!isNaN(webcamIndex)) {
                  const webcamItem = document.querySelector(`#${resortId}-submenu .submenu-item[data-webcam-index="${webcamIndex}"]`);
                  if (webcamItem) {
                    document.querySelectorAll('.submenu-item').forEach(item => {
                      item.classList.remove('active');
                    });
                    webcamItem.classList.add('active');

                    const targetSection = document.getElementById(webcamItem.getAttribute('data-target'));
                    if (targetSection) {
                      targetSection.classList.add('active');

                      const videoContainer = targetSection.querySelector('.video-container');
                      if (videoContainer) {
                        const resort = data.find(r => r.id === resortId);
                        if (resort) {
                          const webcams = resort.links || resort.webcams || [];
                          if (webcams[webcamIndex]) {
                            const videoUrl = webcams[webcamIndex].video || webcams[webcamIndex].link;
                            if (videoUrl) {
                              const player = createVideoPlayer(videoUrl, videoContainer, `${resortId}-${webcamIndex}`, webcams[webcamIndex].video_type);
                              if (player) activePlayers.push(player);

                              addBookmarkButton(
                                videoContainer,
                                resortId,
                                webcamIndex,
                                webcams[webcamIndex].name,
                                videoUrl,
                                webcams[webcamIndex].video_type
                              );

                              updateWeatherDisplay(resortId);
                            } else {
                              videoContainer.innerHTML = '<div class="error-message">No video stream available</div>';
                            }
                          } else {
                            videoContainer.innerHTML = '<div class="error-message">No video stream available</div>';
                          }
                        }
                      }
                    }
                  }
                }
              } else {
                const mainSection = document.getElementById(`${resortId}-main`);
                if (mainSection) {
                  mainSection.classList.add('active');

                  loadAllWebcams(resortId);
                }
              }

              const dropdownToggle = resortMenuItem.querySelector('.dropdown-toggle');
              if (dropdownToggle) {
                dropdownToggle.innerHTML = '<i class="bi bi-chevron-up"></i>';
              }
            } else {
              const targetSection = document.getElementById(resortId);
              if (targetSection) {
                targetSection.classList.add('active');
              }
            }

            if (weatherData && weatherData.length > 0) {
              updateWeatherDisplay(resortId);
            } else {
              fetch('weather.json?v=' + new Date().getTime())
                .then(response => {
                  if (!response.ok) {
                    console.warn('Weather data not available');
                    return null;
                  }
                  return response.json();
                })
                .then(data => {
                  if (data) {
                    weatherData = data;
                    console.log('Weather data loaded:', weatherData.length, 'locations');
                    updateWeatherDisplay(resortId);
                  }
                })
                .catch(error => {
                  console.error('Error loading weather data:', error);
                });
            }
          }
        } finally {
          setTimeout(() => {
            window.processingHashChange = false;
            updateFavoriteButtons();
          }, 100);
        }
      }

      function loadAllWebcams(resortId) {
        const resort = data.find(r => r.id === resortId);
        if (!resort) return;

        const webcams = resort.links || resort.webcams || [];
        if (webcams.length === 0) return;

        const mainSection = document.getElementById(`${resortId}-main`);
        if (!mainSection) return;

        let videosGrid = mainSection.querySelector('.videos-grid');
        if (!videosGrid) {
          videosGrid = document.createElement('div');
          videosGrid.className = 'videos-grid';

          const title = mainSection.querySelector('h2');
          if (title) {
            title.after(videosGrid);
          } else {
            mainSection.appendChild(videosGrid);
          }
        }

        videosGrid.innerHTML = '';

        webcams.forEach((webcam, index) => {
          const videoUrl = webcam.video || webcam.link;
          if (!videoUrl) return;

          const videoCard = document.createElement('div');
          videoCard.className = 'video-card';

          const cardTitle = document.createElement('h3');
          cardTitle.textContent = webcam.name;
          videoCard.appendChild(cardTitle);

          const videoContainer = document.createElement('div');
          videoContainer.className = 'video-container';
          videoCard.appendChild(videoContainer);

          videosGrid.appendChild(videoCard);

          const player = createVideoPlayer(videoUrl, videoContainer, `${resortId}-grid-${index}`, webcam.video_type);
          if (player) activePlayers.push(player);

          addBookmarkButton(
            videoContainer,
            resortId,
            index,
            webcam.name,
            videoUrl,
            webcam.video_type
          );
        });

        updateFavoriteButtons();

        updateWeatherDisplay(resortId);
      }

      function initializeResorts(resorts) {
        data = resorts;

        sidebar.innerHTML = '<div class="site-title"><a href="./">Slopes cam</a></div>';
        const defaultContent = document.getElementById('default-message');
        const otherContent = Array.from(document.querySelectorAll('.content-section:not(#default-message)'));
        otherContent.forEach(el => el.remove());

        resorts.forEach(resort => {
          const resortId = resort.id;
          const resortName = resort.name;
          const webcams = resort.links || resort.webcams || [];
          const hasSubmenu = webcams.length > 0;

          if (webcams.length === 0) {
            return;
          }

          const menuItemContainer = document.createElement('div');
          menuItemContainer.className = 'menu-item-container';

          const menuItem = document.createElement('div');
          menuItem.className = 'menu-item';
          menuItem.setAttribute('data-target', resortId);
          if (hasSubmenu) {
            menuItem.setAttribute('data-has-submenu', 'true');
            menuItem.setAttribute('data-resort-id', resortId);
          }
          menuItem.textContent = resortName;
          menuItemContainer.appendChild(menuItem);

          if (hasSubmenu) {
            const dropdownToggle = document.createElement('span');
            dropdownToggle.className = 'dropdown-toggle';
            dropdownToggle.innerHTML = '<i class="bi bi-chevron-down"></i>';
            dropdownToggle.setAttribute('aria-label', 'Toggle submenu');
            menuItem.appendChild(dropdownToggle);

            dropdownToggle.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              const submenu = menuItemContainer.querySelector('.submenu');
              if (submenu) {
                const isActive = submenu.classList.contains('active');

                hideAllSubmenus();

                if (!isActive) {
                  submenu.classList.add('active');
                  menuItem.classList.add('active');
                  this.innerHTML = '<i class="bi bi-chevron-up"></i>';
                }
              }

              // Navigate to the resort main view
              const resortId = menuItem.getAttribute('data-target');
              if (resortId) {
                updateUrlHash(resortId);
                document.querySelectorAll('.content-section').forEach(section => {
                  section.classList.remove('active');
                });
                const defaultMessage = document.getElementById('default-message');
                defaultMessage.classList.remove('active');
                defaultMessage.style.display = 'none';

                const mainSection = document.getElementById(`${resortId}-main`);
                if (mainSection) {
                  mainSection.classList.add('active');

                  disposeAllPlayers();
                  loadAllWebcams(resortId);
                }

                closeSidebar();
              }
            });
          }

          sidebar.appendChild(menuItemContainer);

          const contentSection = document.createElement('div');
          contentSection.className = 'content-section';
          contentSection.id = hasSubmenu ? `${resortId}-main` : resortId;

          const contentTitle = document.createElement('h2');
          contentTitle.textContent = resortName;
          contentTitle.className = 'inline-title';
          contentSection.appendChild(contentTitle);

          mainContent.appendChild(contentSection);

          if (hasSubmenu) {
            const submenu = document.createElement('div');
            submenu.className = 'submenu';
            submenu.id = `${resortId}-submenu`;
            menuItemContainer.appendChild(submenu);

            webcams.forEach((webcam, index) => {
              const webcamName = webcam.name;
              if (!webcamName) return;

              const submenuItem = document.createElement('div');
              submenuItem.className = 'submenu-item';
              submenuItem.setAttribute('data-target', `${resortId}-webcam-${index}`);
              submenuItem.setAttribute('data-webcam-index', index);
              submenuItem.textContent = webcamName;
              submenu.appendChild(submenuItem);

              const webcamSection = document.createElement('div');
              webcamSection.className = 'content-section';
              webcamSection.id = `${resortId}-webcam-${index}`;

              const webcamTitle = document.createElement('h2');
              webcamTitle.textContent = webcamName;
              webcamTitle.className = 'inline-title inline-title-submenu';
              webcamSection.appendChild(webcamTitle);

              const resortLabel = document.createElement('span');
              resortLabel.textContent = resortName;
              resortLabel.className = 'resort-label';
              webcamSection.appendChild(resortLabel);

              const videoContainer = document.createElement('div');
              videoContainer.className = 'video-container';
              webcamSection.appendChild(videoContainer);

              mainContent.appendChild(webcamSection);

              submenuItem.addEventListener('click', function() {
                const webcamIndex = this.getAttribute('data-webcam-index');
                activeWebcam = webcamIndex;

                updateUrlHash(resortId, webcamIndex);

                document.querySelectorAll('.submenu-item').forEach(item => {
                  item.classList.remove('active');
                });
                this.classList.add('active');

                document.querySelectorAll('.content-section').forEach(section => {
                  section.classList.remove('active');
                });

                const defaultMessage = document.getElementById('default-message');
                defaultMessage.classList.remove('active');
                defaultMessage.style.display = 'none';

                const targetSection = document.getElementById(this.getAttribute('data-target'));
                if (targetSection) {
                  targetSection.classList.add('active');

                  disposeAllPlayers();

                  const videoContainer = targetSection.querySelector('.video-container');
                  if (videoContainer && webcams[webcamIndex]) {
                    const videoUrl = webcams[webcamIndex].video || webcams[webcamIndex].link;
                    if (videoUrl) {
                      const player = createVideoPlayer(videoUrl, videoContainer, `${resortId}-${webcamIndex}`, webcams[webcamIndex].video_type);
                      if (player) activePlayers.push(player);

                      updateWeatherDisplay(resortId);
                    } else {
                      videoContainer.innerHTML = '<div class="error-message">No video stream available</div>';
                    }
                  }
                }

                closeSidebar();
              });
            });
          }

          menuItem.addEventListener('click', function(e) {
            if (e.target.classList.contains('dropdown-toggle') || e.target.closest('.dropdown-toggle')) {
              return;
            }

            const target = this.getAttribute('data-target');
            const hasSubmenu = this.getAttribute('data-has-submenu') === 'true';
            const resortId = this.getAttribute('data-resort-id');

            if (resortId) {
              activeResort = resortId;
              activeWebcam = null;
            }

            updateUrlHash(target);

            document.querySelectorAll('.menu-item').forEach(mi => mi.classList.remove('active'));
            this.classList.add('active');

            if (!hasSubmenu) {
              hideAllSubmenus();
            }

            disposeAllPlayers();

            document.querySelectorAll('.content-section').forEach(section => {
              section.classList.remove('active');
            });

            const defaultMessage = document.getElementById('default-message');
            defaultMessage.classList.remove('active');
            defaultMessage.style.display = 'none';

            if (hasSubmenu) {
              const mainSection = document.getElementById(`${target}-main`);
              if (mainSection) {
                mainSection.classList.add('active');

                loadAllWebcams(target);
              }
            } else {
              const targetSection = document.getElementById(target);
              if (targetSection) {
                targetSection.classList.add('active');
              }
            }

            updateWeatherDisplay(target);

            closeSidebar();
          });
        });

        if (!window.location.hash && data.length > 0) {
          return;
        }

        if (window.location.hash) {
          handleHashChange();
        }
      }

      function createVideoPlayer(videoUrl, container, id, videoType) {
        container.innerHTML = '';

        const idParts = id.split('-');
        const resortId = idParts[0];
        let webcamIndex = parseInt(idParts[1]);

        if (idParts.length === 3 && idParts[1] === 'grid') {
          webcamIndex = parseInt(idParts[2]);
        }

        let webcamName = '';
        if (resortId && !isNaN(webcamIndex)) {
          const resort = data.find(r => r.id === resortId);
          if (resort) {
            const webcams = resort.links || resort.webcams || [];
            if (webcams[webcamIndex]) {
              webcamName = webcams[webcamIndex].name || '';
            }
          }
        }

        if (videoType === 'iframe') {
          const iframeContainer = document.createElement('div');
          iframeContainer.className = 'iframe-container';
          iframeContainer.innerHTML = `<iframe src="${videoUrl}" allowfullscreen></iframe>`;
          container.appendChild(iframeContainer);

          if (resortId && !isNaN(webcamIndex)) {
            addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType, 2);
          }

          return {
            dispose: function() {
              container.innerHTML = '';
            }
          };
        }

        if (videoType === 'youtube') {
          const youtubeContainer = document.createElement('div');
          youtubeContainer.className = 'iframe-container';

          const youtubeId = getYoutubeId(videoUrl);
          if (youtubeId) {
            youtubeContainer.innerHTML = `<iframe src="https://www.youtube.com/embed/${youtubeId}?autoplay=1&mute=1" allowfullscreen></iframe>`;
            container.appendChild(youtubeContainer);

            const captureBtn = document.createElement('button');
            captureBtn.className = 'capture-button';
            captureBtn.innerHTML = `
              <i class="bi bi-camera"></i>
              캡처
            `;
            captureBtn.addEventListener('click', () => captureScreenshot(youtubeContainer));
            container.appendChild(captureBtn);

            if (resortId && !isNaN(webcamIndex)) {
              addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType);
            }

            return {
              dispose: function() {
                container.innerHTML = '';
              }
            };
          }
        }

        if (videoType === 'link') {
          const linkContainer = document.createElement('div');
          linkContainer.className = 'd-flex justify-content-center align-items-center link-container';

          const linkButton = document.createElement('a');
          linkButton.href = videoUrl;
          linkButton.target = '_blank';
          linkButton.rel = 'noopener noreferrer';
          linkButton.className = 'btn btn-primary btn-lg';
          linkButton.innerHTML = `
            <i class="bi bi-box-arrow-up-right me-2"></i>
            외부 링크
          `;

          linkContainer.appendChild(linkButton);
          container.appendChild(linkContainer);

          if (resortId && !isNaN(webcamIndex)) {
            addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType, 2);
          }

          return {
            dispose: function() {
              container.innerHTML = '';
            }
          };
        }

        const resort = getResortAndWebcamFromId(id);
        let linkUrl = null;
        if (resort && resort.webcam && resort.webcam.link) {
          linkUrl = resort.webcam.link;
        }

        container.innerHTML = `
          <video
            id="webcam-player-${id}"
            class="video-js vjs-theme-forest vjs-big-play-centered"
            controls
            autoplay
            muted
            playsinline
          >
            <source src="${videoUrl}" type="application/x-mpegURL">
            <p class="vjs-no-js">
              최신 브라우저를 사용하세요.
            </p>
          </video>
        `;

        try {
          const player = videojs(`webcam-player-${id}`, {
            liveui: true,
            responsive: true,
            fluid: false,
            liveTracker: {
              trackingThreshold: 0,
              liveTolerance: 15
            }
          });

          const captureBtn = document.createElement('button');
          captureBtn.className = 'capture-button';
          captureBtn.innerHTML = `
            <i class="bi bi-camera"></i>
            캡처
          `;
          captureBtn.addEventListener('click', () => captureVideoFrame(player));
          container.appendChild(captureBtn);

          if (resortId && !isNaN(webcamIndex)) {
            addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType);
          }

          player.on('error', function() {
            const error = player.error();

            if (error && error.code === 4 && linkUrl) {
              container.innerHTML = `
                <div class="error-message">
                  <p>직접 스트리밍이 제한되었습니다 (403 Forbidden).</p>
                  <button class="btn btn-primary mt-2" onclick="window.open('${linkUrl}', '_blank')">원본 링크에서 보기</button>
                </div>
              `;

              if (resortId && !isNaN(webcamIndex)) {
                addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType, 1);
              }
            } else {
              container.innerHTML = '<div class="error-message">비디오 재생 중 오류가 발생했습니다.</div>';

              if (resortId && !isNaN(webcamIndex)) {
                addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType, 1);
              }
            }
          });

          return player;
        } catch (e) {
          console.error('Error creating video player:', e);
          container.innerHTML = '<div class="error-message">비디오 플레이어를 생성하는 중 오류가 발생했습니다.</div>';

          if (resortId && !isNaN(webcamIndex)) {
            addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType, 1);
          }

          return null;
        }
      }

      function addBookmarkButton(container, resortId, webcamIndex, webcamName, videoUrl, videoType, type = 0) {
        if (typeof resortId === 'string' && resortId.includes('favorite-player')) {
          return;
        }

        if (container.querySelector('.bookmark-button')) {
          return;
        }

        const bookmarkBtn = document.createElement('button');
        bookmarkBtn.className = 'bookmark-button';
        bookmarkBtn.setAttribute('data-resort-id', resortId);
        bookmarkBtn.setAttribute('data-webcam-index', webcamIndex);
        bookmarkBtn.innerHTML = `
          <span class="bookmark-icon"><i class="bi bi-bookmark"></i></span>
          북마크
        `;
        bookmarkBtn.addEventListener('click', function() {
          toggleFavorite(
            resortId,
            webcamIndex,
            webcamName,
            videoUrl,
            videoType
          );
        });
        container.appendChild(bookmarkBtn);

        if (type === 1) {
          bookmarkBtn.classList.add('bookmark-button-error');
        } else if (type === 2) {
          bookmarkBtn.classList.add('bookmark-button-link');
        }
      }

      function captureVideoFrame(player) {
        try {
          const canvas = document.createElement('canvas');
          const video = player.el().querySelector('video');

          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;

          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          const dataURL = canvas.toDataURL('image/png');
          downloadImage(dataURL, 'webcam-capture.png');

          const container = player.el().parentNode;
          const successMsg = document.createElement('div');
          successMsg.className = 'alert alert-success position-absolute top-0 start-50 translate-middle-x mt-3 success-message';
          successMsg.textContent = '캡처에 성공했습니다.';
          container.appendChild(successMsg);

          setTimeout(() => {
            successMsg.remove();
          }, 2000);

        } catch (e) {
          console.error('Error capturing frame:', e);
          alert('캡처 중 오류가 발생했습니다.');
        }
      }

      function captureScreenshot(container) {
        try {
          const iframe = container.querySelector('iframe');
          if (!iframe) {
            alert('캡처할 콘텐츠를 찾을 수 없습니다.');
            return;
          }

          html2canvas(container).then(canvas => {
            const dataURL = canvas.toDataURL('image/png');
            downloadImage(dataURL, 'webcam-capture.png');

            const successMsg = document.createElement('div');
            successMsg.className = 'alert alert-success position-absolute top-0 start-50 translate-middle-x mt-3 success-message';
            successMsg.textContent = '캡처 완료!';
            container.appendChild(successMsg);

            setTimeout(() => {
              successMsg.remove();
            }, 2000);
          });
        } catch (e) {
          console.error('Error capturing screenshot:', e);
          alert('캡처 중 오류가 발생했습니다.');
        }
      }

      function downloadImage(dataURL, filename) {
        const link = document.createElement('a');
        link.href = dataURL;
        link.download = filename;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function getResortAndWebcamFromId(id) {
        if (!id || !id.includes('-')) return null;

        const parts = id.split('-');
        if (parts.length < 2) return null;

        const resortId = parts[0];
        let webcamIndex = parseInt(parts[1]);

        if (parts.length === 3 && parts[1] === 'grid') {
          webcamIndex = parseInt(parts[2]);
        }

        if (isNaN(webcamIndex)) return null;

        const resort = data.find(r => r.id === resortId);
        if (!resort) return null;

        const webcams = resort.links || resort.webcams || [];
        if (!webcams[webcamIndex]) return null;

        return {
          resort: resort,
          webcam: webcams[webcamIndex]
        };
      }

      function getYoutubeId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
      }

      function toggleSidebar() {
        sidebar.classList.toggle('active');
        sidebarBackdrop.classList.toggle('active');
      }

      function closeSidebar() {
        if (window.innerWidth <= 768) {
          sidebar.classList.remove('active');
          sidebarBackdrop.classList.remove('active');
        }
      }

      toggleMenu.addEventListener('click', toggleSidebar);

      sidebarBackdrop.addEventListener('click', closeSidebar);

      window.addEventListener('resize', function() {
        isMobile = window.innerWidth <= 768;
        if (window.innerWidth > 768) {
          sidebar.classList.remove('active');
          sidebarBackdrop.classList.remove('active');
        }
      });

      window.addEventListener('hashchange', handleHashChange);

      function initializeApp() {
        let initialWeatherDataPromise = Promise.resolve(null);

        if (window.location.hash) {
          initialWeatherDataPromise = fetch('weather.json?v=' + new Date().getTime())
            .then(response => {
              if (!response.ok) {
                console.warn('Weather data not available');
                return null;
              }
              return response.json();
            })
            .then(weatherResult => {
              if (weatherResult) {
                weatherData = weatherResult;
                console.log('Weather data loaded:', weatherData.length, 'locations');
                return weatherResult;
              }
              return null;
            })
            .catch(error => {
              console.error('Error loading weather data:', error);
              return null;
            });
        }

        fetch('links.json?v=' + new Date().getTime())
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(responseData => {
            if (Array.isArray(responseData) && responseData.length > 0) {
              initializeResorts(responseData);

              return initialWeatherDataPromise.then(existingWeatherData => {
                if (existingWeatherData) {
                  return existingWeatherData;
                } else {
                  return fetch('weather.json?v=' + new Date().getTime())
                    .then(response => {
                      if (!response.ok) {
                        console.warn('Weather data not available');
                        return null;
                      }
                      return response.json();
                    });
                }
              });
            } else {
              throw new Error('Invalid data format');
            }
          })
          .then(weatherResult => {
            if (weatherResult) {
              weatherData = weatherResult;
              console.log('Weather data loaded:', weatherData.length, 'locations');

              if (window.location.hash) {
                const parts = window.location.hash.substring(1).split('/');
                const resortId = parts[0];
                if (resortId) {
                  updateWeatherDisplay(resortId);
                }
              }

              updateAllResortsWeather();
            }

            if (window.location.hash) {
              handleHashChange();
            } else {
              updateFavoritesDisplay();
            }
          })
          .catch(error => {
            console.error('Error initializing app:', error);
            const defaultMessage = document.getElementById('default-message');
            if (defaultMessage) {
              defaultMessage.innerHTML = '<div class="error-message p-5 text-center"><h3>리조트 정보를 불러오지 못했습니다.</h3><p>페이지를 새로고침하세요.</p></div>';
              defaultMessage.classList.add('active');
            } else {
              mainContent.innerHTML = '<div class="error-message">리조트 정보를 불러오지 못했습니다.</div>';
            }
          });
      }

      initializeApp();
    });
  </script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-TDF3M6JH2R"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-TDF3M6JH2R');
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const addToHomeButton = document.getElementById('addToHomeButton');
      const installationModal = document.getElementById('installationModal');
      const closeModal = document.getElementById('closeModal');
      const iOSInstructions = document.getElementById('iOSInstructions');
      const androidInstructions = document.getElementById('androidInstructions');
      let deferredPrompt;

      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

      const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                          window.navigator.standalone || document.referrer.includes('android-app://');

      if (isIOS) {
        iOSInstructions.style.display = 'block';
        androidInstructions.style.display = 'none';
      } else {
        iOSInstructions.style.display = 'none';
        androidInstructions.style.display = 'block';
      }

      if ((isIOS || /Android/.test(navigator.userAgent)) && !isStandalone) {
        addToHomeButton.style.display = 'flex';
      }

      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        addToHomeButton.style.display = 'flex';
      });

      addToHomeButton.addEventListener('click', () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
              console.log('User accepted the install prompt');
              addToHomeButton.style.display = 'none';
            }
            deferredPrompt = null;
          });
        } else {
          installationModal.style.display = 'block';
        }
      });

      closeModal.addEventListener('click', () => {
        installationModal.style.display = 'none';
      });

      window.addEventListener('appinstalled', (evt) => {
        addToHomeButton.style.display = 'none';
      });

      // Info button functionality
      const infoButton = document.getElementById('infoButton');
      const infoModal = document.getElementById('infoModal');
      const closeInfoModal = document.getElementById('closeInfoModal');

      infoButton.addEventListener('click', () => {
        infoModal.style.display = 'flex';
      });

      closeInfoModal.addEventListener('click', () => {
        infoModal.style.display = 'none';
      });

      infoModal.addEventListener('click', (e) => {
        if (e.target === infoModal) {
          infoModal.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>


